<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Load Analyzer – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.16);
      --border-subtle: rgba(148, 163, 184, 0.4);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #020617 0, #000 60%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 16px;
    }

    .app-shell {
      max-width: 1160px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .brand-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .company-code {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .top-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .small-pill {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.8);
      font-size: 0.8rem;
    }

    .small-pill span {
      opacity: 0.9;
    }

    .lang-toggle button {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 0.8rem;
      cursor: pointer;
    }

    .lang-toggle button.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    nav.tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      overflow-x: auto;
      padding-bottom: 4px;
    }

    nav.tabs button {
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.86rem;
      cursor: pointer;
      white-space: nowrap;
    }

    nav.tabs button.active {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 500;
    }

    main {
      border-radius: 18px;
      background: radial-gradient(circle at top left, #020617 0, #020617 60%);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 16px;
      box-shadow: 0 28px 80px rgba(0, 0, 0, 0.9);
    }

    section.tab {
      display: none;
    }

    section.tab.active {
      display: block;
    }

    .section-header {
      margin-bottom: 10px;
    }

    .section-header h2 {
      font-size: 1.05rem;
      margin-bottom: 4px;
    }

    .section-header p {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, #020617 0, #020617 60%);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      padding: 14px 16px;
    }

    .card h3 {
      font-size: 0.98rem;
      margin-bottom: 6px;
    }

    .card p {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    input,
    select,
    textarea {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 11px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 7px 9px;
      color: var(--text-main);
      font-size: 0.86rem;
      width: 100%;
    }

    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .btn {
      padding: 7px 13px;
      border-radius: 999px;
      border: none;
      font-size: 0.86rem;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color: #020617;
      font-weight: 600;
    }

    .btn-outline {
      background: transparent;
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.78rem;
    }

    .small-muted {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .kpi-card {
      border-radius: 16px;
      padding: 10px 12px;
      background: radial-gradient(circle at top left, #020617 0, #020617 60%);
      border: 1px solid rgba(148, 163, 184, 0.55);
    }

    .kpi-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .kpi-chip {
      margin-top: 3px;
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: inline-block;
      color: var(--text-muted);
    }

    #map {
      width: 100%;
      height: 260px;
      border-radius: 14px;
      margin-top: 8px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    canvas {
      max-width: 100%;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.8);
      text-align: left;
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
    }

    .tag {
      font-size: 0.73rem;
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      color: var(--text-muted);
      display: inline-block;
    }

    .ai-tools-card h4 {
      font-size: 0.88rem;
      margin-top: 6px;
      margin-bottom: 2px;
    }

    .ai-output-box {
      margin-top: 8px;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.96);
      font-size: 0.8rem;
      white-space: pre-wrap;
      line-height: 1.5;
      max-height: 210px;
      overflow-y: auto;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
      background: var(--accent);
    }

    .support-footer {
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .link {
      color: var(--accent);
      text-decoration: none;
    }

    .link:hover {
      text-decoration: underline;
    }

    @media (max-width: 720px) {
      main {
        padding: 12px;
      }

      .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-title">Smart Load Analyzer – Admin</div>
        <div class="brand-sub" data-i18n="brandSubtitle">
          Manage your company profile, analyze trips, and optimize truck loads.
        </div>
        <div class="company-code">
          Company code: <span id="companyCodeValue">–</span>
        </div>
      </div>

      <div class="top-controls">
        <div class="small-pill">
          <span id="currentCompanyNameLabel" data-i18n="noCompany">
            No company signed in
          </span>
        </div>

        <div class="lang-toggle">
          <button id="btnLangEn" class="active" onclick="setLanguage('en')">
            EN
          </button>
          <button id="btnLangAr" onclick="setLanguage('ar')">AR</button>
        </div>
      </div>
    </header>

    <nav class="tabs">
      <button class="active" data-tab-target="loginTab" data-i18n="tabLogin">
        Login / Sign up
      </button>
      <button data-tab-target="dashboardTab" data-i18n="tabDashboard">
        Dashboard
      </button>
      <button data-tab-target="analyzeTab" data-i18n="tabAnalyze">
        Analyze
      </button>
      <button data-tab-target="optimizeTab" data-i18n="tabOptimize">
        Optimization
      </button>
      <button data-tab-target="supportTab" data-i18n="tabSupport">
        Support
      </button>
    </nav>

    <main>
      <!-- LOGIN TAB -->
      <section id="loginTab" class="tab active">
        <div class="section-header">
          <h2 data-i18n="loginTitle">Company access</h2>
          <p data-i18n="loginSubtitle">
            Login to an existing company or create a new company account to
            start analyzing trips.
          </p>
        </div>

        <div class="grid-2">
          <div class="card">
            <h3 data-i18n="loginExistingTitle">Login (existing company)</h3>
            <p class="small-muted" data-i18n="loginExistingDesc">
              Use the email and password you used when creating the company
              account.
            </p>

            <form id="loginForm">
              <div>
                <label for="loginEmail" data-i18n="fieldEmail">Email</label>
                <input
                  id="loginEmail"
                  type="email"
                  required
                  placeholder="company@logistics.com"
                />
              </div>
              <div>
                <label for="loginPassword" data-i18n="fieldPassword">
                  Password
                </label>
                <input
                  id="loginPassword"
                  type="password"
                  required
                  placeholder="••••••••"
                />
              </div>

              <div class="btn-row">
                <button type="submit" class="btn btn-primary" data-i18n="btnLogin">
                  Login
                </button>
              </div>

              <p id="loginStatus" class="small-muted"></p>
            </form>
          </div>

          <div class="card">
            <h3 data-i18n="signupTitle">Sign up (new company)</h3>
            <p class="small-muted" data-i18n="signupDesc">
              Register a new company. After sign up, you will see a unique
              company code that you can use internally.
            </p>

            <form id="signupForm">
              <div>
                <label for="signupCompanyName" data-i18n="fieldCompanyName">
                  Company name
                </label>
                <input
                  id="signupCompanyName"
                  type="text"
                  required
                  placeholder="Saudi Logistics Co."
                />
              </div>

              <div>
                <label for="signupTruckCount" data-i18n="fieldTruckCount">
                  Number of trucks (fleet size)
                </label>
                <input
                  id="signupTruckCount"
                  type="number"
                  min="1"
                  required
                  placeholder="20"
                />
              </div>

              <div class="grid-3" style="margin-top:4px;">
                <div>
                  <label for="signupAvgLoad" data-i18n="fieldAvgLoad">
                    Current average load (%)
                  </label>
                  <input
                    id="signupAvgLoad"
                    type="number"
                    min="0"
                    max="100"
                    step="1"
                    required
                    placeholder="40"
                  />
                </div>
                <div>
                  <label for="signupDailyCost" data-i18n="fieldDailyCost">
                    Approx. daily operating cost (SAR)
                  </label>
                  <input
                    id="signupDailyCost"
                    type="number"
                    min="0"
                    required
                    placeholder="3000"
                  />
                </div>
                <div>
                  <label for="signupDailyCo2" data-i18n="fieldDailyCo2">
                    Approx. daily CO₂ emissions (kg)
                  </label>
                  <input
                    id="signupDailyCo2"
                    type="number"
                    min="0"
                    required
                    placeholder="250"
                  />
                </div>
              </div>

              <div class="grid-2" style="margin-top:6px;">
                <div>
                  <label for="signupEmail" data-i18n="fieldEmail">Email</label>
                  <input
                    id="signupEmail"
                    type="email"
                    required
                    placeholder="admin@company.com"
                  />
                </div>
                <div>
                  <label for="signupPassword" data-i18n="fieldPassword">
                    Password
                  </label>
                  <input
                    id="signupPassword"
                    type="password"
                    minlength="6"
                    required
                    placeholder="••••••••"
                  />
                </div>
              </div>

              <div class="btn-row">
                <button type="submit" class="btn btn-primary" data-i18n="btnSignup">
                  Sign up
                </button>
                <button
                  type="button"
                  class="btn btn-outline btn-sm"
                  onclick="authSignOut()"
                  data-i18n="btnLogout"
                >
                  Logout
                </button>
              </div>

              <p id="signupStatus" class="small-muted"></p>
            </form>
          </div>
        </div>
      </section>

      <!-- DASHBOARD TAB -->
      <section id="dashboardTab" class="tab">
        <div class="section-header">
          <h2 data-i18n="dashboardTitle">Company dashboard</h2>
          <p data-i18n="dashboardSubtitle">
            See your current load utilization, daily costs, CO₂ footprint, and
            main routes.
          </p>
        </div>

        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label" data-i18n="kpiAvgLoad">Average load</div>
            <div id="kpiAvgLoadValue" class="kpi-value">-- %</div>
            <div class="kpi-chip" id="kpiAvgLoadChip">–</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label" data-i18n="kpiDailyCost">
              Daily operating cost
            </div>
            <div id="kpiDailyCostValue" class="kpi-value">-- SAR</div>
            <div class="kpi-chip" id="kpiDailyCostChip">–</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label" data-i18n="kpiDailyCo2">
              Daily CO₂ emissions
            </div>
            <div id="kpiDailyCo2Value" class="kpi-value">-- kg</div>
            <div class="kpi-chip" id="kpiDailyCo2Chip">–</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label" data-i18n="kpiFleetUtil">
              Fleet utilization insight
            </div>
            <div id="kpiFleetUtilValue" class="kpi-value">–</div>
            <div class="kpi-chip" id="kpiFleetUtilChip">–</div>
          </div>
        </div>

        <div class="grid-2" style="margin-top:14px;">
          <div class="card">
            <h3 data-i18n="mapTitle">Main lanes (example)</h3>
            <p class="small-muted" data-i18n="mapDesc">
              Example map of Riyadh – Jeddah – Dammam corridor. You can extend
              this to your real network.
            </p>
            <div id="map"></div>
          </div>

          <div class="card">
            <h3 data-i18n="chartTitle">Load trend (sample)</h3>
            <p class="small-muted" data-i18n="chartDesc">
              Simple load % trend. You can connect it directly to your trips
              data later.
            </p>
            <canvas id="loadChart" height="150"></canvas>
          </div>
        </div>
      </section>

      <!-- ANALYZE TAB -->
      <section id="analyzeTab" class="tab">
        <div class="section-header">
          <h2 data-i18n="analyzeTitle">Analyze trips</h2>
          <p data-i18n="analyzeSubtitle">
            Add trips manually or upload a CSV file, then let the AI engine
            analyze your network.
          </p>
        </div>

        <div class="grid-3">
          <div class="card">
            <h3 data-i18n="manualTripTitle">Add a trip manually</h3>
            <form id="manualTripForm">
              <div class="grid-2">
                <div>
                  <label for="tripOrigin" data-i18n="fieldOrigin">Origin</label>
                  <input
                    id="tripOrigin"
                    type="text"
                    placeholder="Riyadh"
                    required
                  />
                </div>
                <div>
                  <label for="tripDestination" data-i18n="fieldDestination">
                    Destination
                  </label>
                  <input
                    id="tripDestination"
                    type="text"
                    placeholder="Jeddah"
                    required
                  />
                </div>
              </div>

              <div class="grid-3">
                <div>
                  <label for="tripDistance" data-i18n="fieldDistance">
                    Distance (km)
                  </label>
                  <input
                    id="tripDistance"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="950"
                  />
                </div>
                <div>
                  <label for="tripLoadUtil" data-i18n="fieldLoadUtil">
                    Load utilization (%)
                  </label>
                  <input
                    id="tripLoadUtil"
                    type="number"
                    min="0"
                    max="100"
                    step="1"
                    placeholder="60"
                  />
                </div>
                <div>
                  <label for="tripCost" data-i18n="fieldTripCost">
                    Trip cost (SAR)
                  </label>
                  <input
                    id="tripCost"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="1200"
                  />
                </div>
              </div>

              <div class="grid-3">
                <div>
                  <label for="tripCo2" data-i18n="fieldTripCo2">
                    CO₂ emissions (kg)
                  </label>
                  <input
                    id="tripCo2"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="180"
                  />
                </div>
                <div>
                  <label for="tripIsReturn" data-i18n="fieldIsReturn">
                    Is return trip?
                  </label>
                  <select id="tripIsReturn">
                    <option value="no" selected data-i18n="no">No</option>
                    <option value="yes" data-i18n="yes">Yes</option>
                  </select>
                </div>
                <div>
                  <label for="tripIsEmpty" data-i18n="fieldIsEmpty">
                    Empty / near-empty?
                  </label>
                  <select id="tripIsEmpty">
                    <option value="no" selected data-i18n="no">No</option>
                    <option value="yes" data-i18n="yes">Yes</option>
                  </select>
                </div>
              </div>

              <div class="btn-row">
                <button type="submit" class="btn btn-primary" data-i18n="btnAddTrip">
                  Add trip
                </button>
              </div>

              <p id="manualTripStatus" class="small-muted"></p>
            </form>
          </div>

          <div class="card">
            <h3 data-i18n="csvTitle">Upload trips CSV</h3>
            <p class="small-muted" data-i18n="csvDesc">
              Upload a CSV file with your trips. Each row should contain origin,
              destination, distance, load utilization, cost, and CO₂ if
              available.
            </p>

            <input id="csvFileInput" type="file" accept=".csv" />
            <div class="btn-row">
              <button
                type="button"
                class="btn btn-outline btn-sm"
                onclick="importTripsFromCsv()"
                data-i18n="btnImportCsv"
              >
                Import CSV
              </button>
            </div>

            <p id="csvStatus" class="small-muted"></p>
          </div>

          <!-- AI tools card -->
          <div class="card ai-tools-card">
            <h3 data-i18n="aiToolsTitle">AI Optimization Tools</h3>
            <p class="small-muted" data-i18n="aiToolsSubtitle">
              Uses your trips data to run detailed diagnostics and generate a
              PDF report for management.
            </p>

            <h4 data-i18n="aiTripAnalyzerTitle">AI Trip Analyzer (Detailed)</h4>
            <p class="small-muted" data-i18n="aiTripAnalyzerDesc">
              Detects low-utilization lanes, empty runs, cost hotspots, and CO₂
              issues.
            </p>
            <button
              class="btn btn-primary btn-sm"
              onclick="runTripAIAnalysis()"
              data-i18n="aiTripAnalyzerRun"
            >
              Run AI analysis on trips
            </button>
            <div id="aiTripAnalyzerOutput" class="ai-output-box" style="margin-bottom:8px;">
              <p data-i18n="aiTripAnalyzerHint">
                Once you click the button, the AI will read all your trips from
                the database and show a detailed diagnostic report here.
              </p>
            </div>

            <h4 data-i18n="aiPdfTitle">AI PDF Sustainability & Cost Report</h4>
            <p class="small-muted" data-i18n="aiPdfDesc">
              Generates a professional PDF summary of load, empty trips, cost
              and CO₂ for your company.
            </p>
            <button
              class="btn btn-outline btn-sm"
              onclick="generatePdfAIReport()"
              data-i18n="aiPdfButton"
            >
              Generate PDF report
            </button>
            <div id="aiPdfReportStatus" class="ai-output-box">
              <p data-i18n="aiPdfHint">
                Run the AI Trip Analyzer first for best results, then click PDF
                to download the report.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- OPTIMIZATION TAB -->
      <section id="optimizeTab" class="tab">
        <div class="section-header">
          <h2 data-i18n="optimizeTitle">Optimization scenarios</h2>
          <p data-i18n="optimizeSubtitle">
            See example optimization scenarios based on your trips and fleet.
          </p>
        </div>

        <div class="card">
          <h3 data-i18n="optimizeTableTitle">
            Example optimization suggestions
          </h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th data-i18n="colLane">Lane</th>
                  <th data-i18n="colCurrentLoad">Current load %</th>
                  <th data-i18n="colSuggestedLoad">Suggested load %</th>
                  <th data-i18n="colSavings">Estimated savings</th>
                  <th data-i18n="colAction">Action</th>
                </tr>
              </thead>
              <tbody id="optimizationTableBody">
                <tr>
                  <td>Riyadh → Jeddah</td>
                  <td>45%</td>
                  <td>80%</td>
                  <td>+ 1,200 SAR / day</td>
                  <td>
                    <span class="tag">Merge 2 daily trips into 1</span>
                  </td>
                </tr>
                <tr>
                  <td>Jeddah → Dammam</td>
                  <td>55%</td>
                  <td>85%</td>
                  <td>+ 800 SAR / day</td>
                  <td>
                    <span class="tag">Use smaller truck on low days</span>
                  </td>
                </tr>
                <tr>
                  <td>Riyadh → Dammam</td>
                  <td>35%</td>
                  <td>75%</td>
                  <td>+ 950 SAR / day</td>
                  <td>
                    <span class="tag">Consolidate with Riyadh → Jubail</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <p class="small-muted" style="margin-top: 6px" data-i18n="optimizeNote">
            You can later connect this table directly to an optimization engine
            (e.g., mixed-integer model) using your live trips data.
          </p>
        </div>
      </section>

      <!-- SUPPORT TAB -->
      <section id="supportTab" class="tab">
        <div class="section-header">
          <h2 data-i18n="supportTitle">Support & contact</h2>
          <p data-i18n="supportSubtitle">
            If you have any issues with the portal or want to extend the AI
            features, contact the Smart Load Analyzer team.
          </p>
        </div>

        <div class="grid-2">
          <div class="card">
            <h3 data-i18n="supportFormTitle">Contact form</h3>
            <form id="supportForm">
              <div>
                <label for="supportName" data-i18n="fieldName">Name</label>
                <input id="supportName" type="text" placeholder="Your name" />
              </div>
              <div>
                <label for="supportEmail" data-i18n="fieldEmail">Email</label>
                <input
                  id="supportEmail"
                  type="email"
                  placeholder="you@company.com"
                />
              </div>
              <div>
                <label for="supportMessage" data-i18n="fieldMessage">
                  Message
                </label>
                <textarea
                  id="supportMessage"
                  placeholder="Describe your issue or question…"
                ></textarea>
              </div>
              <div class="btn-row">
                <button
                  type="button"
                  class="btn btn-outline btn-sm"
                  onclick="fakeSupportSubmit()"
                  data-i18n="btnSend"
                >
                  Send (demo)
                </button>
              </div>
              <p id="supportStatus" class="small-muted"></p>
            </form>
          </div>

          <div class="card">
            <h3 data-i18n="supportInfoTitle">How we use your data</h3>
            <p class="small-muted" data-i18n="supportInfoBody">
              Trip and company data are used only for optimization and AI
              analytics inside this portal. For a production system, you can
              host the database in your preferred region and control access
              fully.
            </p>

            <div class="support-footer">
              <span class="status-dot"></span>
              <span data-i18n="statusDemo">
                Demo mode: data is stored per company UID in Firestore demo
                project.
              </span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

  <!-- jsPDF for PDF reports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ===================== TRANSLATIONS =====================
    const translations = {
      en: {
        brandSubtitle:
          "Manage your company profile, analyze trips, and optimize truck loads.",
        noCompany: "No company signed in",
        tabLogin: "Login / Sign up",
        tabDashboard: "Dashboard",
        tabAnalyze: "Analyze",
        tabOptimize: "Optimization",
        tabSupport: "Support",
        loginTitle: "Company access",
        loginSubtitle:
          "Login to an existing company or create a new company account to start analyzing trips.",
        loginExistingTitle: "Login (existing company)",
        loginExistingDesc:
          "Use the email and password you used when creating the company account.",
        fieldEmail: "Email",
        fieldPassword: "Password",
        btnLogin: "Login",
        signupTitle: "Sign up (new company)",
        signupDesc:
          "Register a new company. After sign up, you will see a unique company code that you can use internally.",
        fieldCompanyName: "Company name",
        fieldTruckCount: "Number of trucks (fleet size)",
        fieldAvgLoad: "Current average load (%)",
        fieldDailyCost: "Approx. daily operating cost (SAR)",
        fieldDailyCo2: "Approx. daily CO₂ emissions (kg)",
        btnSignup: "Sign up",
        btnLogout: "Logout",
        dashboardTitle: "Company dashboard",
        dashboardSubtitle:
          "See your current load utilization, daily costs, CO₂ footprint, and main routes.",
        kpiAvgLoad: "Average load",
        kpiDailyCost: "Daily operating cost",
        kpiDailyCo2: "Daily CO₂ emissions",
        kpiFleetUtil: "Fleet utilization insight",
        mapTitle: "Main lanes (example)",
        mapDesc:
          "Example map of Riyadh – Jeddah – Dammam corridor. You can extend this to your real network.",
        chartTitle: "Load trend (sample)",
        chartDesc:
          "Simple load % trend. You can connect it directly to your trips data later.",
        analyzeTitle: "Analyze trips",
        analyzeSubtitle:
          "Add trips manually or upload a CSV file, then let the AI engine analyze your network.",
        manualTripTitle: "Add a trip manually",
        fieldOrigin: "Origin",
        fieldDestination: "Destination",
        fieldDistance: "Distance (km)",
        fieldLoadUtil: "Load utilization (%)",
        fieldTripCost: "Trip cost (SAR)",
        fieldTripCo2: "CO₂ emissions (kg)",
        fieldIsReturn: "Is return trip?",
        fieldIsEmpty: "Empty / near-empty?",
        yes: "Yes",
        no: "No",
        btnAddTrip: "Add trip",
        csvTitle: "Upload trips CSV",
        csvDesc:
          "Upload a CSV file with your trips. Each row should contain origin, destination, distance, load utilization, cost, and CO₂ if available.",
        btnImportCsv: "Import CSV",
        aiToolsTitle: "AI Optimization Tools",
        aiToolsSubtitle:
          "These tools use your real trips data to generate diagnostics and management-ready reports.",
        aiTripAnalyzerTitle: "AI Trip Analyzer (Detailed)",
        aiTripAnalyzerDesc:
          "Uses your real trips data to detect low-utilization lanes, empty runs, cost hotspots, and CO₂ issues — then generates optimization ideas.",
        aiTripAnalyzerRun: "Run AI analysis on trips",
        aiTripAnalyzerHint:
          "Once you click the button, the AI will read all your trips from the database and show a detailed diagnostic report here.",
        aiTripAnalyzerNoTrips:
          "No trips found for this company yet. Please add or upload trips first.",
        aiTripAnalyzerLoading:
          "Running AI analysis on your trips... please wait.",
        aiTripAnalyzerError:
          "Error while reading trips. Please try again later.",
        aiPdfTitle: "AI PDF Sustainability & Cost Report",
        aiPdfDesc:
          "Generates a professional PDF report that summarizes your load utilization, empty trips, costs, and CO₂ emissions.",
        aiPdfButton: "Generate PDF report",
        aiPdfHint:
          "Run the AI Trip Analyzer first for best results, then click the PDF button to download a full report for your company.",
        aiPdfNeedAnalysis:
          "Please run the AI Trip Analyzer first so we can build a detailed report.",
        aiPdfSuccess: "PDF report generated and downloaded.",
        aiPdfError: "Error while generating PDF report. Please try again.",
        optimizeTitle: "Optimization scenarios",
        optimizeSubtitle:
          "See example optimization scenarios based on your trips and fleet.",
        optimizeTableTitle: "Example optimization suggestions",
        colLane: "Lane",
        colCurrentLoad: "Current load %",
        colSuggestedLoad: "Suggested load %",
        colSavings: "Estimated savings",
        colAction: "Action",
        optimizeNote:
          "You can later connect this table directly to an optimization engine (e.g., mixed-integer model) using your live trips data.",
        supportTitle: "Support & contact",
        supportSubtitle:
          "If you have any issues with the portal or want to extend the AI features, contact the Smart Load Analyzer team.",
        supportFormTitle: "Contact form",
        fieldName: "Name",
        fieldMessage: "Message",
        btnSend: "Send (demo)",
        supportInfoTitle: "How we use your data",
        supportInfoBody:
          "Trip and company data are used only for optimization and AI analytics inside this portal. For a production system, you can host the database in your preferred region and control access fully.",
        statusDemo:
          "Demo mode: data is stored per company UID in Firestore demo project.",
      },
      ar: {
        brandSubtitle:
          "إدارة بيانات الشركة، تحليل الرحلات، وتحسين تحميل الشاحنات.",
        noCompany: "لا يوجد شركة مسجّلة دخول",
        tabLogin: "تسجيل الدخول / إنشاء شركة",
        tabDashboard: "لوحة التحكم",
        tabAnalyze: "تحليل الرحلات",
        tabOptimize: "التحسين",
        tabSupport: "الدعم",
        loginTitle: "وصول الشركات",
        loginSubtitle:
          "سجّل الدخول لشركة موجودة أو أنشئ حساب شركة جديد لبدء تحليل الرحلات.",
        loginExistingTitle: "تسجيل الدخول (شركة موجودة)",
        loginExistingDesc:
          "استخدم البريد وكلمة المرور التي أنشأت بهما حساب الشركة.",
        fieldEmail: "البريد الإلكتروني",
        fieldPassword: "كلمة المرور",
        btnLogin: "تسجيل الدخول",
        signupTitle: "إنشاء حساب (شركة جديدة)",
        signupDesc:
          "سجّل شركة جديدة. بعد الإنشاء سيظهر لك كود خاص بالشركة للاستخدام الداخلي.",
        fieldCompanyName: "اسم الشركة",
        fieldTruckCount: "عدد الشاحنات في الأسطول",
        fieldAvgLoad: "متوسط نسبة التحميل الحالي (%)",
        fieldDailyCost: "متوسط التكلفة التشغيلية اليومية (ريال)",
        fieldDailyCo2: "متوسط الانبعاثات اليومية (كجم CO₂)",
        btnSignup: "إنشاء حساب",
        btnLogout: "تسجيل الخروج",
        dashboardTitle: "لوحة تحكم الشركة",
        dashboardSubtitle:
          "اطّلع على مستوى استغلال الحمولة، التكلفة اليومية، البصمة الكربونية، والمسارات الرئيسية.",
        kpiAvgLoad: "متوسط التحميل",
        kpiDailyCost: "التكلفة التشغيلية اليومية",
        kpiDailyCo2: "انبعاثات CO₂ اليومية",
        kpiFleetUtil: "مؤشر استغلال الأسطول",
        mapTitle: "المسارات الرئيسية (مثال)",
        mapDesc:
          "خريطة تجريبية لممر الرياض – جدة – الدمام. يمكن ربطها لاحقًا بشبكتك الفعلية.",
        chartTitle: "اتجاه نسبة التحميل (تجريبي)",
        chartDesc:
          "منحنى بسيط لنسبة التحميل. يمكن ربطه مباشرة ببيانات الرحلات لاحقًا.",
        analyzeTitle: "تحليل الرحلات",
        analyzeSubtitle:
          "أضِف الرحلات يدويًا أو ارفع ملف CSV، ثم اترك محرك الذكاء الاصطناعي يحلل الشبكة.",
        manualTripTitle: "إضافة رحلة يدويًا",
        fieldOrigin: "نقطة الانطلاق",
        fieldDestination: "نقطة الوصول",
        fieldDistance: "المسافة (كم)",
        fieldLoadUtil: "نسبة التحميل (%)",
        fieldTripCost: "تكلفة الرحلة (ريال)",
        fieldTripCo2: "انبعاثات CO₂ (كجم)",
        fieldIsReturn: "هل هي رحلة عودة؟",
        fieldIsEmpty: "هل هي رحلة فارغة/قريبة من الفارغة؟",
        yes: "نعم",
        no: "لا",
        btnAddTrip: "إضافة الرحلة",
        csvTitle: "رفع ملف CSV للرحلات",
        csvDesc:
          "ارفع ملف CSV يحتوي على الرحلات. كل صف يفضّل أن يتضمن: مصدر، وجهة، مسافة، نسبة تحميل، تكلفة، وانبعاثات CO₂ إن وجدت.",
        btnImportCsv: "استيراد الملف",
        aiToolsTitle: "أدوات الذكاء الاصطناعي",
        aiToolsSubtitle:
          "تستخدم هذه الأدوات بيانات الرحلات الفعلية لتوليد تشخيصات وتقارير جاهزة للإدارة.",
        aiTripAnalyzerTitle: "محلل الرحلات بالذكاء الاصطناعي (تفصيلي)",
        aiTripAnalyzerDesc:
          "يحلل بيانات الرحلات الفعلية لاكتشاف انخفاض استغلال الحمولة، والرحلات الفارغة، ونقاط التكلفة العالية، ومشاكل الانبعاثات، ثم يقترح أفكار تحسين.",
        aiTripAnalyzerRun: "تشغيل تحليل الذكاء الاصطناعي للرحلات",
        aiTripAnalyzerHint:
          "بعد الضغط على الزر، سيقرأ الذكاء الاصطناعي كل الرحلات من قاعدة البيانات ويعرض تقرير تشخيصي مفصل هنا.",
        aiTripAnalyzerNoTrips:
          "لا توجد رحلات مسجلة لهذه الشركة حتى الآن. رجاءً أضِف رحلات أو ارفع ملف CSV أولاً.",
        aiTripAnalyzerLoading:
          "جاري تشغيل تحليل الذكاء الاصطناعي على الرحلات... انتظر قليلًا.",
        aiTripAnalyzerError:
          "حدث خطأ أثناء قراءة بيانات الرحلات. حاول مرة أخرى لاحقًا.",
        aiPdfTitle: "تقرير PDF للتكلفة والاستدامة (ذكاء اصطناعي)",
        aiPdfDesc:
          "ينشئ تقرير PDF احترافي يختصر استغلال الحمولة، الرحلات الفارغة، التكاليف، وانبعاثات CO₂.",
        aiPdfButton: "إنشاء تقرير PDF",
        aiPdfHint:
          "لأفضل نتيجة، قم أولاً بتشغيل محلل الرحلات بالذكاء الاصطناعي، ثم اضغط زر PDF لتحميل التقرير لشركتك.",
        aiPdfNeedAnalysis:
          "رجاءً قم بتشغيل محلل الرحلات بالذكاء الاصطناعي أولاً لنبني التقرير بالتفصيل.",
        aiPdfSuccess: "تم إنشاء وتحميل تقرير PDF بنجاح.",
        aiPdfError: "حدث خطأ أثناء إنشاء تقرير PDF. حاول مرة أخرى.",
        optimizeTitle: "سيناريوهات التحسين",
        optimizeSubtitle:
          "اطّلع على أمثلة لسيناريوهات تحسين مبنية على الرحلات والأسطول.",
        optimizeTableTitle: "أمثلة على اقتراحات التحسين",
        colLane: "المسار",
        colCurrentLoad: "نسبة التحميل الحالية",
        colSuggestedLoad: "نسبة التحميل المقترحة",
        colSavings: "التوفير التقديري",
        colAction: "الإجراء المقترح",
        optimizeNote:
          "يمكن لاحقًا ربط هذا الجدول مباشرةً بمحرك تحسين رياضي يعتمد على بيانات الرحلات الحية.",
        supportTitle: "الدعم والتواصل",
        supportSubtitle:
          "في حال وجود أي مشاكل في البوابة أو رغبة في توسيع أدوات الذكاء الاصطناعي، تواصل مع فريق Smart Load Analyzer.",
        supportFormTitle: "نموذج التواصل",
        fieldName: "الاسم",
        fieldMessage: "الرسالة",
        btnSend: "إرسال (تجريبي)",
        supportInfoTitle: "كيف نستخدم بياناتك",
        supportInfoBody:
          "تُستخدم بيانات الرحلات والشركة فقط لأغراض التحسين والتحليل داخل هذه البوابة. في بيئة إنتاجية يمكن استضافة قاعدة البيانات في المنطقة التي تختارها مع تحكم كامل في الصلاحيات.",
        statusDemo:
          "وضع تجريبي: يتم تخزين البيانات لكل شركة حسب UID في مشروع Firestore تجريبي.",
      },
    };

    let currentLang = "en";

    function setLanguage(lang) {
      currentLang = lang === "ar" ? "ar" : "en";
      document.documentElement.lang = currentLang;
      document.body.dir = currentLang === "ar" ? "rtl" : "ltr";

      document.getElementById("btnLangEn").classList.toggle(
        "active",
        currentLang === "en"
      );
      document.getElementById("btnLangAr").classList.toggle(
        "active",
        currentLang === "ar"
      );

      const dict = translations[currentLang] || {};
      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });
    }

    function t(key) {
      return (translations[currentLang] || {})[key] || key;
    }

    // ===================== FIREBASE INIT =====================
    const firebaseConfig = {
      // نفس القيم اللي كنت مستخدمها في المشروع السابق
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentCompanyData = null;
    let loadChart = null;
    let lastAIReportText = "";

    // ===================== TABS + ACCESS CONTROL =====================
    document.querySelectorAll("nav.tabs button").forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-tab-target");

        // حظر الدخول على التابات بدون تسجيل
        if (targetId !== "loginTab" && !currentUser) {
          const loginStatus = document.getElementById("loginStatus");
          if (loginStatus) {
            loginStatus.textContent =
              currentLang === "ar"
                ? "رجاءً قم بتسجيل الدخول أو إنشاء حساب شركة أولًا للوصول لهذه الصفحات."
                : "Please login or sign up first to access these sections.";
          }

          // رجع على تبويب اللوجين
          document
            .querySelectorAll("nav.tabs button")
            .forEach((b) => b.classList.remove("active"));
          const loginBtn = document.querySelector(
            "button[data-tab-target='loginTab']"
          );
          if (loginBtn) loginBtn.classList.add("active");

          document.querySelectorAll("section.tab").forEach((tab) => {
            tab.classList.toggle("active", tab.id === "loginTab");
          });
          return;
        }

        document
          .querySelectorAll("nav.tabs button")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        document.querySelectorAll("section.tab").forEach((tab) => {
          tab.classList.toggle("active", tab.id === targetId);
        });
      });
    });

    // ===================== MAP =====================
    let map;

    function initMap() {
      map = L.map("map").setView([24.7136, 46.6753], 5.5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      const riyadh = [24.7136, 46.6753];
      const jeddah = [21.4858, 39.1925];
      const dammam = [26.4207, 50.0888];

      L.polyline([riyadh, jeddah], { weight: 3 }).addTo(map);
      L.polyline([riyadh, dammam], { weight: 3 }).addTo(map);
      L.polyline([jeddah, dammam], { weight: 3 }).addTo(map);

      L.marker(riyadh).addTo(map).bindPopup("Riyadh");
      L.marker(jeddah).addTo(map).bindPopup("Jeddah");
      L.marker(dammam).addTo(map).bindPopup("Dammam");
    }

    // ===================== CHART =====================
    function initLoadChart() {
      const ctx = document.getElementById("loadChart");
      if (!ctx) return;
      loadChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
          datasets: [
            {
              label: "Load %",
              data: [40, 42, 45, 47, 50, 48, 52],
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
            },
          },
        },
      });
    }

    function updateKpisFromStats(stats) {
      const avgLoad = Number(stats.avgLoad || 0);
      const dailyCost = Number(stats.dailyCost || 0);
      const dailyCo2 = Number(stats.dailyCo2 || 0);

      document.getElementById("kpiAvgLoadValue").textContent =
        avgLoad.toFixed(1) + " %";
      document.getElementById("kpiDailyCostValue").textContent =
        dailyCost.toFixed(0) + " SAR";
      document.getElementById("kpiDailyCo2Value").textContent =
        dailyCo2.toFixed(1) + " kg";

      const loadChip = document.getElementById("kpiAvgLoadChip");
      if (avgLoad < 50) {
        loadChip.textContent = "Low utilization – big improvement potential";
      } else if (avgLoad < 75) {
        loadChip.textContent = "Moderate utilization – room to improve";
      } else {
        loadChip.textContent = "High utilization – focus on specific lanes";
      }

      const costChip = document.getElementById("kpiDailyCostChip");
      costChip.textContent =
        "If load improves by 10–15 pts, daily cost per ton-km will drop.";

      const co2Chip = document.getElementById("kpiDailyCo2Chip");
      co2Chip.textContent =
        "Reducing empty trips will directly lower this number.";

      const utilValue = document.getElementById("kpiFleetUtilValue");
      const utilChip = document.getElementById("kpiFleetUtilChip");
      if (avgLoad < 50) {
        utilValue.textContent = "⚠ Underutilized";
        utilChip.textContent = "Focus on consolidation and rescheduling.";
      } else if (avgLoad < 75) {
        utilValue.textContent = "◼ Balanced";
        utilChip.textContent = "Target weak lanes with low load.";
      } else {
        utilValue.textContent = "✅ Strong";
        utilChip.textContent = "Protect performance and watch costs.";
      }

      if (loadChart) {
        const base = Math.max(20, Math.min(70, avgLoad - 10));
        loadChart.data.datasets[0].data = [
          base,
          base + 2,
          base + 4,
          base + 3,
          base + 6,
          base + 5,
          base + 8,
        ];
        loadChart.update();
      }
    }

    // ===================== AUTH & COMPANY DATA =====================
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      const statusEl = document.getElementById("loginStatus");
      statusEl.textContent = "";

      try {
        statusEl.textContent = "Signing in...";
        const cred = await auth.signInWithEmailAndPassword(email, password);
        currentUser = cred.user;
        statusEl.textContent = "Signed in.";
        document
          .querySelector("button[data-tab-target='dashboardTab']")
          .click();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Login error: " + err.message;
      }
    });

    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById("signupStatus");
      statusEl.textContent = "";

      const companyName = document
        .getElementById("signupCompanyName")
        .value.trim();
      const trucksCount = Number(
        document.getElementById("signupTruckCount").value
      );
      const avgLoad = Number(document.getElementById("signupAvgLoad").value);
      const dailyCost = Number(
        document.getElementById("signupDailyCost").value
      );
      const dailyCo2 = Number(document.getElementById("signupDailyCo2").value);
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value.trim();

      if (!companyName || !email || !password) {
        statusEl.textContent = "Please fill all required fields.";
        return;
      }

      try {
        statusEl.textContent = "Creating company and user...";
        const cred = await auth.createUserWithEmailAndPassword(
          email,
          password
        );
        const uid = cred.user.uid;

        await db.collection("companies").doc(uid).set({
          companyName,
          trucksCount: trucksCount || 0,
          stats: {
            avgLoad: avgLoad || 0,
            dailyCost: dailyCost || 0,
            dailyCo2: dailyCo2 || 0,
          },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        statusEl.textContent =
          "Company created. Your company code is: " + uid;
        document.getElementById("companyCodeValue").textContent = uid;
        document.getElementById("currentCompanyNameLabel").textContent =
          companyName;
        currentUser = cred.user;
        currentCompanyData = {
          companyName,
          trucksCount,
          stats: {
            avgLoad,
            dailyCost,
            dailyCo2,
          },
        };
        updateKpisFromStats(currentCompanyData.stats);

        document
          .querySelector("button[data-tab-target='dashboardTab']")
          .click();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Signup error: " + err.message;
      }
    });

    async function authSignOut() {
      try {
        await auth.signOut();
        currentUser = null;
        currentCompanyData = null;
        document.getElementById("companyCodeValue").textContent = "–";
        document.getElementById("currentCompanyNameLabel").textContent =
          t("noCompany");

        // رجّع تبويب اللوجين
        const loginBtn = document.querySelector(
          "button[data-tab-target='loginTab']"
        );
        if (loginBtn) loginBtn.click();
      } catch (err) {
        console.error(err);
      }
    }

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      if (user) {
        const uid = user.uid;
        document.getElementById("companyCodeValue").textContent = uid;
        await loadCompanyDoc(uid);
      }
    });

    async function loadCompanyDoc(uid) {
      try {
        const docSnap = await db.collection("companies").doc(uid).get();
        if (!docSnap.exists) return;
        const data = docSnap.data();
        currentCompanyData = data;
        document.getElementById("currentCompanyNameLabel").textContent =
          data.companyName || t("noCompany");
        updateKpisFromStats(data.stats || {});
      } catch (err) {
        console.error("Error loading company doc:", err);
      }
    }

    // ===================== MANUAL TRIP ADD =====================
    const manualTripForm = document.getElementById("manualTripForm");

    manualTripForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById("manualTripStatus");
      statusEl.textContent = "";

      if (!currentUser || !currentUser.uid) {
        statusEl.textContent = "Please login as a company admin first.";
        return;
      }

      const origin = document.getElementById("tripOrigin").value.trim();
      const destination = document
        .getElementById("tripDestination")
        .value.trim();
      const distance = Number(
        document.getElementById("tripDistance").value || 0
      );
      const loadUtil = Number(
        document.getElementById("tripLoadUtil").value || 0
      );
      const cost = Number(document.getElementById("tripCost").value || 0);
      const co2 = Number(document.getElementById("tripCo2").value || 0);
      const isReturn =
        document.getElementById("tripIsReturn").value === "yes";
      const isEmpty = document.getElementById("tripIsEmpty").value === "yes";

      try {
        await db
          .collection("companies")
          .doc(currentUser.uid)
          .collection("trips")
          .add({
            origin,
            destination,
            distanceKm: distance,
            loadUtilization: loadUtil,
            costSAR: cost,
            co2Kg: co2,
            isReturnTrip: isReturn,
            isEmpty: isEmpty,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

        statusEl.textContent = "Trip added.";
        manualTripForm.reset();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error adding trip: " + err.message;
      }
    });

    // ===================== CSV IMPORT =====================
    async function importTripsFromCsv() {
      const fileInput = document.getElementById("csvFileInput");
      const statusEl = document.getElementById("csvStatus");
      statusEl.textContent = "";

      if (!currentUser || !currentUser.uid) {
        statusEl.textContent = "Please login as a company admin first.";
        return;
      }

      const file = fileInput.files[0];
      if (!file) {
        statusEl.textContent = "Please choose a CSV file.";
        return;
      }

      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
        if (lines.length <= 1) {
          statusEl.textContent = "CSV seems empty.";
          return;
        }

        const header = lines[0].split(",");
        const idxOrigin = header.findIndex((h) =>
          /origin/i.test(h.trim())
        );
        const idxDest = header.findIndex((h) =>
          /dest/i.test(h.trim())
        );
        const idxDist = header.findIndex((h) =>
          /dist/i.test(h.trim())
        );
        const idxLoad = header.findIndex((h) =>
          /load/i.test(h.trim())
        );
        const idxCost = header.findIndex((h) =>
          /cost/i.test(h.trim())
        );
        const idxCo2 = header.findIndex((h) =>
          /co2/i.test(h.trim())
        );

        let imported = 0;

        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(",");
          if (!cols.length) continue;

          const origin = idxOrigin >= 0 ? cols[idxOrigin].trim() : "Unknown";
          const destination = idxDest >= 0 ? cols[idxDest].trim() : "Unknown";
          const distance =
            idxDist >= 0 ? Number(cols[idxDist]) || 0 : 0;
          const load =
            idxLoad >= 0 ? Number(cols[idxLoad]) || 0 : 0;
          const cost =
            idxCost >= 0 ? Number(cols[idxCost]) || 0 : 0;
          const co2 = idxCo2 >= 0 ? Number(cols[idxCo2]) || 0 : 0;

          await db
            .collection("companies")
            .doc(currentUser.uid)
            .collection("trips")
            .add({
              origin,
              destination,
              distanceKm: distance,
              loadUtilization: load,
              costSAR: cost,
              co2Kg: co2,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          imported++;
        }

        statusEl.textContent = `Imported ${imported} trips from CSV.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error importing CSV: " + err.message;
      }
    }

    // ===================== AI TRIP ANALYZER =====================
    async function runTripAIAnalysis() {
      const outputEl = document.getElementById("aiTripAnalyzerOutput");
      if (!outputEl) return;

      if (!currentUser || !currentUser.uid) {
        outputEl.textContent =
          "Please login as a company admin first.";
        return;
      }

      outputEl.textContent = t("aiTripAnalyzerLoading");

      try {
        const snapshot = await db
          .collection("companies")
          .doc(currentUser.uid)
          .collection("trips")
          .get();

        if (snapshot.empty) {
          outputEl.textContent = t("aiTripAnalyzerNoTrips");
          lastAIReportText = "";
          return;
        }

        const trips = [];
        snapshot.forEach((doc) => {
          trips.push({ id: doc.id, ...doc.data() });
        });

        const report = buildAITripAnalysisReport(trips);
        lastAIReportText = report;
        outputEl.textContent = report;
      } catch (err) {
        console.error("[AI Trip Analyzer] error:", err);
        outputEl.textContent = t("aiTripAnalyzerError");
        lastAIReportText = "";
      }
    }

    function buildAITripAnalysisReport(trips) {
      if (!trips || trips.length === 0) {
        return "No trips to analyze.";
      }

      let totalTrips = trips.length;
      let totalDistance = 0;
      let totalCost = 0;
      let totalCo2 = 0;
      let totalLoadUtil = 0;
      let countWithLoad = 0;
      let emptyTrips = 0;

      const laneStats = {};

      for (const trip of trips) {
        const distance = Number(trip.distanceKm || trip.distance || 0);
        const cost = Number(trip.costSAR || trip.cost || 0);
        const co2 = Number(trip.co2Kg || trip.co2 || 0);

        let load = trip.loadUtilization;
        if (typeof load === "string") load = Number(load);
        if (load > 1.5) load = load / 100;

        totalDistance += distance;
        totalCost += cost;
        totalCo2 += co2;

        if (load >= 0 && !Number.isNaN(load)) {
          totalLoadUtil += load;
          countWithLoad++;
        }

        if (trip.isEmpty === true || load === 0) {
          emptyTrips++;
        }

        const origin = trip.origin || trip.from || "Unknown";
        const destination = trip.destination || trip.to || "Unknown";
        const laneKey = origin + " → " + destination;

        if (!laneStats[laneKey]) {
          laneStats[laneKey] = {
            trips: 0,
            distance: 0,
            loadSum: 0,
            countLoad: 0,
          };
        }

        laneStats[laneKey].trips++;
        laneStats[laneKey].distance += distance;

        if (load >= 0 && !Number.isNaN(load)) {
          laneStats[laneKey].loadSum += load;
          laneStats[laneKey].countLoad++;
        }
      }

      const avgLoad =
        countWithLoad > 0 ? (totalLoadUtil / countWithLoad) * 100 : 0;
      const emptyRatio = (emptyTrips / totalTrips) * 100;

      const lanesArray = Object.entries(laneStats).map(([lane, data]) => {
        const avgLaneLoad =
          data.countLoad > 0
            ? (data.loadSum / data.countLoad) * 100
            : 0;
        return {
          lane,
          trips: data.trips,
          distance: data.distance,
          avgLoad: avgLaneLoad,
        };
      });

      lanesArray.sort((a, b) => b.trips - a.trips);

      const topBusy = lanesArray.slice(0, 3);
      const lowUtilLanes = lanesArray.filter(
        (l) => l.avgLoad > 0 && l.avgLoad < 60
      );
      const highUtilLanes = lanesArray.filter(
        (l) => l.avgLoad >= 80
      );

      let report = "";

      report += "=== AI Trip Diagnostic Summary ===\n";
      report += `Total trips analyzed: ${totalTrips}\n`;
      report += `Average distance per trip: ${safeRound(
        totalDistance / totalTrips
      )} km\n`;
      report += `Average load utilization (for trips with data): ${safeRound(
        avgLoad
      )}%\n`;
      report += `Empty / near-empty trips: ${emptyTrips} (${safeRound(
        emptyRatio
      )}%)\n`;
      report += `Estimated total cost in dataset: ${safeRound(
        totalCost
      )} SAR\n`;
      report += `Estimated total CO₂ emissions: ${safeRound(
        totalCo2
      )} kg\n\n`;

      report += "=== Busiest Lanes (by number of trips) ===\n";
      if (topBusy.length === 0) {
        report += "No lane information.\n";
      } else {
        for (const lane of topBusy) {
          report += `• ${lane.lane}: ${lane.trips} trips, avg load ${safeRound(
            lane.avgLoad
          )}%\n`;
        }
      }
      report += "\n";

      report += "=== Lanes with Low Utilization (<60%) ===\n";
      if (lowUtilLanes.length === 0) {
        report += "No clear low-utilization lanes detected.\n";
      } else {
        for (const lane of lowUtilLanes) {
          report += `• ${lane.lane}: avg load ${safeRound(
            lane.avgLoad
          )}% over ${lane.trips} trips\n`;
        }
      }
      report += "\n";

      report += "=== Lanes with High Utilization (>=80%) ===\n";
      if (highUtilLanes.length === 0) {
        report += "No consistently high-utilization lanes detected.\n";
      } else {
        for (const lane of highUtilLanes) {
          report += `• ${lane.lane}: avg load ${safeRound(
            lane.avgLoad
          )}% over ${lane.trips} trips\n`;
        }
      }
      report += "\n";

      report += "=== AI Optimization Suggestions ===\n";

      if (avgLoad < 70) {
        report += `• Overall load utilization is only ~${safeRound(
          avgLoad
        )}%. Consider:\n`;
        report +=
          "  - Consolidating low-volume lanes into fewer, fuller trips.\n";
        report +=
          "  - Shifting some customers/lanes to scheduled milk-runs instead of single-drops.\n";
      } else {
        report += `• Overall load utilization (~${safeRound(
          avgLoad
        )}%) is reasonable. Focus on specific weak lanes.\n`;
      }

      if (emptyRatio > 15) {
        report += `• Empty / near-empty trips are ~${safeRound(
          emptyRatio
        )}% of all trips.\n`;
        report +=
          "  - Identify return trips with no load and try to match them with backhaul demand.\n";
        report +=
          "  - Review contracts with customers on those lanes to enable load sharing.\n";
      }

      if (lowUtilLanes.length > 0) {
        report +=
          "• Low-utilization lanes detected. Good candidates to:\n";
        report +=
          "  - Merge multiple days into fewer but fuller trips.\n";
        report +=
          "  - Switch to smaller vehicles if consolidation is not possible.\n";
      }

      if (totalCo2 > 0 && emptyRatio > 10) {
        report +=
          "• A significant part of CO₂ emissions likely comes from empty or weakly-loaded trips. Prioritize them in your sustainability roadmap.\n";
      }

      report += "\n=== Next Steps for This Company ===\n";
      report +=
        "1) Choose 1–2 lanes from the low-utilization list and redesign their weekly plan.\n";
      report +=
        "2) Track the same KPIs (load%, cost, empty trips, CO₂) for 4 weeks after changes.\n";
      report +=
        "3) Run this AI analyzer again to measure the impact.\n";

      return report;
    }

    function safeRound(num, digits = 1) {
      if (!Number.isFinite(num)) return 0;
      const m = Math.pow(10, digits);
      return Math.round(num * m) / m;
    }

    // ===================== AI PDF REPORT =====================
    function generatePdfAIReport() {
      const statusEl = document.getElementById("aiPdfReportStatus");
      if (!lastAIReportText) {
        statusEl.textContent = t("aiPdfNeedAnalysis");
        return;
      }

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const margin = 10;
        const maxWidth = 190;
        const lineHeight = 7;
        let y = 18;

        const title =
          "Smart Load Analyzer – AI Trip & Sustainability Report";
        doc.setFontSize(14);
        doc.text(title, margin, y);
        y += 10;

        doc.setFontSize(10);
        const companyName =
          (currentCompanyData && currentCompanyData.companyName) ||
          "Company";
        const uid = currentUser ? currentUser.uid : "N/A";
        doc.text("Company: " + companyName, margin, y);
        y += 6;
        doc.text("Company code (UID): " + uid, margin, y);
        y += 8;

        const lines = doc.splitTextToSize(lastAIReportText, maxWidth);
        for (const line of lines) {
          if (y > 280) {
            doc.addPage();
            y = 15;
          }
          doc.text(line, margin, y);
          y += lineHeight;
        }

        const filename = `AI_Trip_Report_${companyName
          .replace(/\s+/g, "_")
          .slice(0, 40)}.pdf`;
        doc.save(filename);
        statusEl.textContent = t("aiPdfSuccess");
      } catch (err) {
        console.error("PDF error:", err);
        statusEl.textContent = t("aiPdfError");
      }
    }

    // ===================== SUPPORT DEMO =====================
    function fakeSupportSubmit() {
      const statusEl = document.getElementById("supportStatus");
      statusEl.textContent =
        "This is a demo. In production this would send an email or ticket.";
    }

    // ===================== INIT =====================
    document.addEventListener("DOMContentLoaded", () => {
      setLanguage("en");
      initMap();
      initLoadChart();
    });
  </script>
</body>
</html>
