<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Logixperts - Smart Load Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --card: #111827;
      --accent: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      max-width: 1200px; width: 100%;
      background: #020617;
      border-radius: 32px;
      border: 1px solid #1f2937;
      padding: 20px 20px 26px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display: flex; flex-direction: column; gap: 18px;
    }

    header {
      display: flex; justify-content: space-between; align-items: center;
      gap: 16px; padding: 10px 14px 6px;
      border-radius: 26px;
      background: radial-gradient(circle at left top, #22c55e20, #020617 55%);
      border: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .brand-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand { display: flex; align-items: center; gap: 14px; }

    .badge-logo {
      width: 42px; height: 42px;
      border-radius: 18px;
      border: 1px solid #16a34a;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
      display: flex; align-items: center; justify-content: center;
      color: #ecfdf5; font-weight: 800; font-size: 18px;
      box-shadow: 0 10px 25px rgba(34,197,94,.55);
    }

    .brand-text h1 {
      font-size: 20px; font-weight: 800;
      letter-spacing: .06em; text-transform: uppercase;
    }

    .brand-text span {
      display:block; font-size:11px; color:var(--muted);
      text-transform:uppercase; letter-spacing:.12em; margin-top:2px;
    }

    .back-link {
      font-size: 12px;
      color: var(--muted);
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      cursor: pointer;
      white-space: nowrap;
    }

    .back-link:hover {
      color: #e5e7eb;
      border-color: #22c55e;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .lang-switch {
      font-size: 13px;
      background: #020617;
      border: 1px solid #1f2937;
      padding: 6px 12px;
      border-radius: 999px;
      color: var(--muted);
      cursor: pointer;
    }

    .team-pill {
      padding: 8px 14px; border-radius: 999px;
      border: 1px solid #1f2937; background:#020617b3;
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
    }
    .team-pill span { color:#bbf7d0; font-weight:600; }

    .company-code-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #16a34a;
      background: #022c22;
      font-size: 12px;
      color: #bbf7d0;
      display: none;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .hero {
      display:flex; flex-wrap:wrap; gap:20px;
      padding:14px 18px 18px;
      border-radius:26px;
      background: radial-gradient(circle at top right,#22c55e12,#020617 55%);
      border:1px solid #1f2937;
    }

    .hero-main{flex:1 1 260px;}
    .hero-title{font-size:24px;font-weight:700;margin-bottom:6px;}
    .hero-sub{font-size:13px;color:var(--muted);max-width:420px;line-height:1.4;}

    .hero-tags{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;}
    .hero-tag{
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid #1f2937;background:#020617;color:#9ca3af;
    }
    .hero-tag strong{color:#a7f3d0;}

    .hero-highlight{
      font-size:12px;margin-top:10px;padding:8px 10px;
      border-radius:14px;background:#022c2230;border:1px solid #064e3b;
      color:#a7f3d0;
    }

    .hero-metric{
      flex:0 0 220px;display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;align-content:center;
    }

    .hero-metric-card{
      padding:10px;border-radius:16px;border:1px solid #1f2937;background:#020617;
    }
    .hero-metric-card h3{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .hero-metric-card p{font-size:17px;font-weight:700;}

    .nav-tabs{
      display:flex;flex-wrap:wrap;gap:8px;padding:4px;
      border-radius:999px;background:#020617;border:1px solid #1f2937;
      align-self:center;
      margin-top: 10px;
    }
    .nav-tab{
      border:none;background:transparent;padding:8px 14px;border-radius:999px;
      font-size:12px;color:var(--muted);cursor:pointer;
      display:none; /* Ù…Ø®ÙÙŠØ© Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    }
    .nav-tab.active{
      background:#16a34a;color:#ecfdf5;font-weight:600;
      box-shadow:0 10px 25px rgba(34,197,94,.55);
    }

    main{margin-top:4px;display:grid;grid-template-columns:minmax(0,1fr);}
    .view{display:none;animation:fade .25s ease-out;}
    .view.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);} }

    .card{
      background:var(--card);border-radius:24px;border:1px solid var(--border);
      padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:baseline;
      gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }
    .card-title{font-size:16px;font-weight:600;}
    .card-sub{font-size:12px;color:var(--muted);}

    .two-column{
      display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,0.9fr);gap:14px;
    }

    .right-column{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    @media(max-width:900px){
      .two-column{grid-template-columns:minmax(0,1fr);}
      header{flex-direction:column;align-items:flex-start;}
      .hero{flex-direction:column;}
      .hero-metric{width:100%;}
      .header-right{margin-left:0;}
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;margin-bottom:12px;
    }
    .kpi-card{
      padding:12px;border-radius:18px;border:1px solid #1f2937;background:#020617;
    }
    .kpi-label{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:700;margin-bottom:2px;}
    .kpi-footnote{font-size:11px;color:#4ade80;}

    #dashboardChart,#optChart{
      width:100% !important;
      height:220px !important;
      max-height:220px !important;
      display:block;
    }

    #map{
      width:100%;
      height:230px;
      border-radius:18px;
      border:1px solid #1f2937;
      overflow:hidden;
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#020617;
      border:1px solid #1f2937;font-size:11px;color:var(--muted);
    }
    .pill-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}

    .login-form,.analyze-form,.signup-form{display:grid;gap:10px;margin-top:6px;}
    label{font-size:12px;margin-bottom:2px;color:var(--muted);}
    .field{display:flex;flex-direction:column;gap:4px;}

    input,select{
      padding:9px 10px;border-radius:12px;border:1px solid #374151;
      background:#020617;color:var(--text);font-size:13px;
    }
    textarea{
      padding:9px 10px;border-radius:12px;border:1px solid #374151;
      background:#020617;color:var(--text);font-size:13px;
      resize:vertical;
      min-height:80px;
    }
    input:focus,select:focus,textarea:focus{border-color:#22c55e;outline:none;}

    .password-input{
      display:flex;align-items:center;gap:6px;
    }
    .password-input input{flex:1;}
    .password-toggle{
      border:1px solid #374151;
      background:#020617;
      color:#9ca3af;
      border-radius:999px;
      font-size:11px;
      padding:5px 10px;
      cursor:pointer;
    }

    .btn{
      border:none;padding:9px 14px;border-radius:999px;
      font-size:13px;cursor:pointer;font-weight:600;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .btn-primary{
      background:linear-gradient(to right,#16a34a,#22c55e);
      color:#ecfdf5;box-shadow:0 14px 30px rgba(34,197,94,.55);
    }
    .btn-secondary{
      background:#020617;border:1px solid #374151;color:#e5e7eb;
    }

    .truck-list{
      margin-top:8px;border-radius:18px;border:1px solid #1f2937;
      overflow:hidden;background:#020617;
    }
    .truck-row{
      display:grid;grid-template-columns:1.2fr .9fr 1.3fr;
      padding:8px 10px;font-size:12px;border-bottom:1px solid #111827;
      align-items:center;
    }
    .truck-row.header{background:#020617;font-weight:600;color:var(--muted);font-size:11px;}

    .chip{
      padding:3px 8px;border-radius:999px;font-size:11px;
      border:1px solid #1f2937;display:inline-flex;align-items:center;gap:4px;
    }
    .chip.good{border-color:#16a34a;color:#bbf7d0;background:#052e16;}
    .chip.warn{border-color:#f97316;color:#fed7aa;background:#451a03;}
    .chip.bad{border-color:#ef4444;color:#fecaca;background:#450a0a;}

    .opt-summary{font-size:12px;color:var(--muted);margin-top:6px;}
    .opt-summary strong{color:#a7f3d0;}

    .hint{font-size:11px;color:var(--muted);margin-top:4px;}
    .hint-error{color:#fecaca;}

    /* stats form */
    .stats-form {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #111827;
    }
    .stats-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      align-items: end;
    }
    .small-field label {
      font-size: 11px;
    }
    .small-field input {
      font-size: 12px;
      padding: 7px 9px;
    }

    .support-footer{
      margin-top:16px;
      display:flex;
      justify-content:flex-start;
    }

    .support-box{
      font-size:12px;
      color:var(--muted);
      padding:10px 14px;
      border-radius:16px;
      border:1px solid #1f2937;
      background:#020617;
      line-height:1.6;
    }

    .support-title{
      font-size:14px;
      color:#22c55e;
      font-weight:600;
      margin-bottom:4px;
      text-align:left;
    }

    .support-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .support-icon{
      font-size:13px;
    }

    footer{margin-top:4px;font-size:10px;color:#4b5563;text-align:right;}
    footer span{color:#a7f3d0;}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand-group">
        <div class="brand">
          <div class="badge-logo">Lx</div>
          <div class="brand-text">
            <h1 id="text_brand">Logixperts</h1>
            <span id="text_subbrand">Smart Load Analyzer</span>
          </div>
        </div>

        <a href="index.html" id="back_link" class="back-link">
          â† Back to role selection
        </a>
      </div>

      <div class="header-right">
        <div class="company-code-pill" id="company_code_badge">
          <span id="company_code_label">Company code:</span>
          <span id="company_code_value"></span>
        </div>

        <div class="team-pill">
          <span id="team_label">Team:</span>&nbsp;<span>Logixperts</span> | <span id="team_event">Naqlthon 4</span>
        </div>

        <button class="lang-switch" id="langSwitcher" type="button" onclick="toggleLanguage()">AR</button>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-main">
        <p class="hero-title" id="hero_title">
          Reduce Empty Trips. Boost Load Factor. Go Greener.
        </p>

        <p class="hero-sub" id="hero_sub">
          Smart Load Analyzer helps freight companies analyze and optimize loads to reduce cost and emissions.
        </p>

        <div class="hero-tags">
          <div class="hero-tag">
            <strong>15â€“25%</strong>&nbsp;<span id="tag_fuel">fuel reduction (simulated)</span>
          </div>
          <div class="hero-tag">
            <strong>AI</strong>&nbsp;<span id="tag_ai">load & route suggestions</span>
          </div>
        </div>

        <div class="hero-highlight" id="hero_highlight">
          This demo scenario shows how merging a new shipment with a low-load return trip improves load factor.
        </div>
      </div>

      <div class="hero-metric">
        <div class="hero-metric-card">
          <h3 id="hero_avg_before_title">Avg load (baseline)</h3>
          <p id="hero-load-before">â€“</p>
        </div>

        <div class="hero-metric-card">
          <h3 id="hero_cost_title">Op. cost / day</h3>
          <p id="hero-cost-before">â€“</p>
        </div>

        <div class="hero-metric-card">
          <h3 id="hero_co2_title">COâ‚‚ / day</h3>
          <p id="hero-co2-before">â€“</p>
        </div>
      </div>
    </section>

    <!-- NAV TABS -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="login-view" id="tab_login">Login / Sign up</button>
      <button class="nav-tab" data-view="dashboard-view" id="tab_dashboard">Dashboard</button>
      <button class="nav-tab" data-view="analyze-view" id="tab_analyze">Analyze Load</button>
      <button class="nav-tab" data-view="optimization-view" id="tab_opt">Optimization Result</button>
    </nav>

    <main>
      <!-- LOGIN / SIGNUP -->
      <section id="login-view" class="view active">
        <div class="two-column">
          <!-- LOGIN -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="login_title">Company Login</div>
                <div class="card-sub" id="login_sub">
                  Access your Smart Load Analyzer workspace.
                </div>
              </div>
            </div>

            <form class="login-form" onsubmit="event.preventDefault(); demoLogin();">
              <div class="field">
                <label id="label_email">Company email</label>
                <input id="company" type="text" placeholder="demo@logixperts.sa" required />
              </div>

              <div class="field">
                <label id="label_password">Password</label>
                <div class="password-input">
                  <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
                  <button
                    type="button"
                    class="password-toggle"
                    onclick="togglePassword('password', this)"
                  >
                    Show
                  </button>
                </div>
              </div>

              <button class="btn btn-primary" type="submit" id="login_btn">
                Login
              </button>

              <p class="hint" id="login_hint">
                Demo credentials: <strong>demo@logixperts.sa</strong> / <strong>Naqlthon4!</strong>
              </p>
              <p id="login-error" class="hint hint-error"></p>
            </form>
          </div>

          <!-- SIGNUP -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="signup_title">Create Company Account</div>
                <div class="card-sub" id="signup_sub">
                  Create your company account to access the system.
                </div>
              </div>
            </div>

            <form class="signup-form" onsubmit="event.preventDefault(); signUp();">
              <div class="field">
                <label id="signup_label_name">Company name</label>
                <input id="signup-name" type="text" placeholder="e.g. Green Freight Co." required />
              </div>

              <div class="field">
                <label id="signup_label_email">Company email</label>
                <input id="signup-email" type="email" placeholder="you@company.sa" required />
              </div>

              <div class="field">
                <label id="signup_label_pass">Password</label>
                <div class="password-input">
                  <input id="signup-password" type="password" placeholder="Choose a strong password" required />
                  <button
                    type="button"
                    class="password-toggle"
                    onclick="togglePassword('signup-password', this)"
                  >
                    Show
                  </button>
                </div>
              </div>

              <div class="field">
                <label id="signup_label_fleet">Fleet size (trucks)</label>
                <input id="signup-fleet" type="number" min="1" step="1" value="20" />
              </div>

              <div class="field">
                <label id="signup_label_plan">Subscription plan</label>
                <select id="signup-plan">
                  <option value="monthly">Starter â€“ 299 SAR / month</option>
                  <option value="6months">Growth â€“ 1,499 SAR / 6 months</option>
                  <option value="yearly">Enterprise â€“ 2,499 SAR / year</option>
                </select>
              </div>

              <button class="btn btn-secondary" id="signup_btn" type="submit">
                Sign up
              </button>
              <p id="signup-message" class="hint"></p>
            </form>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="dash_title">Fleet Overview Dashboard</div>
                <div class="card-sub" id="dash_sub">
                  4 demo trucks on main corridors.
                </div>
              </div>
              <span class="pill"><span class="pill-dot"></span> Demo scenario</span>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-label" id="kpi_trucks_label">Trucks in scenario</div>
                <div class="kpi-value">4</div>
                <div class="kpi-footnote">Riyadh â†” Jeddah / Dammam</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_baseline_label">Avg load (baseline)</div>
                <div class="kpi-value" id="kpi-load-before">â€“</div>
                <div class="kpi-footnote" id="kpi_baseline_note">Before optimization</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_after_label">Avg load (after)</div>
                <div class="kpi-value" id="kpi-load-after">â€“</div>
                <div class="kpi-footnote" id="kpi_after_note">After last run</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_cost_before_label">Op. cost / day</div>
                <div class="kpi-value" id="kpi-cost-before">â€“</div>
                <div class="kpi-footnote" id="kpi_cost_before_note">Simulated SAR</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_cost_after_label">Op. cost / day (after)</div>
                <div class="kpi-value" id="kpi-cost-after">â€“</div>
                <div class="kpi-footnote" id="kpi-cost-savings">â€“</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_co2_before_label">COâ‚‚ / day</div>
                <div class="kpi-value" id="kpi-co2-before">â€“</div>
                <div class="kpi-footnote" id="kpi_co2_before_note">kg COâ‚‚</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_co2_after_label">COâ‚‚ / day (after)</div>
                <div class="kpi-value" id="kpi-co2-after">â€“</div>
                <div class="kpi-footnote" id="kpi-co2-savings">â€“</div>
              </div>
            </div>

            <!-- Company metrics form -->
            <div class="stats-form">
              <div class="stats-form-row">
                <div class="field small-field">
                  <label id="stats_label_load">Company avg load (%)</label>
                  <input id="stats-load" type="number" min="0" max="100" step="1" />
                </div>
                <div class="field small-field">
                  <label id="stats_label_cost">Company op. cost / day (SAR)</label>
                  <input id="stats-cost" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label id="stats_label_co2">Company COâ‚‚ / day (kg)</label>
                  <input id="stats-co2" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label>&nbsp;</label>
                  <button class="btn btn-secondary" type="button" id="stats-save-btn">
                    Save metrics
                  </button>
                </div>
              </div>
              <p class="hint" id="stats_hint"></p>
            </div>

            <canvas id="dashboardChart"></canvas>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="map_title">Truck Positions & Routes</div>
                <div class="card-sub" id="map_sub">
                  Best routes + load factor markers.
                </div>
              </div>
            </div>
            <div id="map"></div>
          </div>
        </div>
      </section>

      <!-- ANALYZE -->
      <section id="analyze-view" class="view">
        <div class="two-column">
          <!-- MANUAL -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="analyze_title">
                  Analyze New Shipment (Manual)
                </div>
                <div class="card-sub" id="analyze_sub">
                  Enter shipment details manually.
                </div>
              </div>
            </div>

            <form class="analyze-form" onsubmit="event.preventDefault(); runOptimization();">
              <div class="field">
                <label id="label_weight">Weight (tons)</label>
                <input id="weight" type="number" min="0" step="0.1" value="8" />
              </div>

              <div class="field">
                <label id="label_volume">Volume (mÂ³)</label>
                <input id="volume" type="number" min="0" step="1" value="28" />
              </div>

              <div class="field">
                <label id="label_destination">Destination city</label>
                <input id="destination" type="text" value="Riyadh" />
              </div>

              <div class="field">
                <label id="label_delivery">Delivery window</label>
                <input id="deliveryTime" type="text" value="Within 24 hours" />
              </div>

              <div class="field">
                <label id="label_priority">Priority</label>
                <select id="priority">
                  <option value="normal">Normal</option>
                  <option value="high">High priority</option>
                  <option value="low">Low / backhaul</option>
                </select>
              </div>

              <button class="btn btn-primary" id="btn_manual_analyze" type="submit">
                Run Manual Optimization
              </button>
            </form>
          </div>

          <!-- RIGHT COLUMN: AI Tools + CSV -->
          <div class="right-column">
            <!-- AI TOOLS CARD -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title" id="ai_title">AI Tools</div>
                  <div class="card-sub" id="ai_sub">
                    Use AI to analyze trips and generate reports (demo).
                  </div>
                </div>
              </div>

              <div class="field">
                <label id="ai_trip_label">Trip description / notes</label>
                <textarea
                  id="ai_trip_text"
                  placeholder="Paste trip summary or issues here..."
                ></textarea>
              </div>

              <button
                class="btn btn-secondary"
                type="button"
                id="ai_trip_btn"
                onclick="runAIToolsAnalysis()"
              >
                Generate AI insights (demo)
              </button>

              <p class="hint" id="ai_trip_output"></p>

              <div class="field" style="margin-top:10px;">
                <label id="ai_pdf_label">PDF AI Report (coming soon)</label>
                <input id="ai_pdf_file" type="file" accept=".pdf" />
              </div>
              <p class="hint" id="ai_pdf_hint">
                In the real system this will send your PDF to an AI backend and return KPIs + summary.
              </p>
            </div>

            <!-- CSV UPLOAD -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title" id="csv_title">Upload Your Trips CSV</div>
                  <div class="card-sub" id="csv_sub">
                    Upload trip history to improve optimization accuracy.
                  </div>
                </div>
              </div>

              <form class="signup-form" onsubmit="event.preventDefault(); analyzeCSV();">
                <div class="field">
                  <label id="csv_label">Choose CSV file</label>
                  <input id="csv_file" type="file" accept=".csv" />
                </div>

                <button class="btn btn-secondary" id="btn_csv">
                  Analyze CSV
                </button>

                <p id="csv_message" class="hint"></p>
              </form>
            </div>
          </div>
        </div>
      </section>

      <!-- OPTIMIZATION -->
      <section id="optimization-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="opt_title">Optimization Result</div>
                <div class="card-sub" id="opt_sub">Recommended load distribution.</div>
              </div>
            </div>

            <div class="truck-list" id="truck-list">
              <div class="truck-row header">
                <div id="opt_col_truck">Truck & Route</div>
                <div id="opt_col_load">Load Factor</div>
                <div id="opt_col_ai">AI Suggestion</div>
              </div>
            </div>

            <p class="opt-summary" id="opt-summary">
              Run manual or CSV analysis to see results.
            </p>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="chart_title">Before vs After Optimization</div>
                <div class="card-sub" id="chart_sub">Average load improvement</div>
              </div>
            </div>
            <canvas id="optChart"></canvas>
          </div>
        </div>

        <!-- OPTIMIZATION SCENARIOS CARD -->
        <div class="card" style="margin-top:14px;">
          <div class="card-header">
            <div>
              <div class="card-title" id="opt_scenarios_title">Optimization Scenarios</div>
              <div class="card-sub" id="opt_scenarios_sub">
                Examples of how Smart Load Analyzer improves utilization.
              </div>
            </div>
          </div>

          <div class="truck-list">
            <div class="truck-row header">
              <div id="opt_scenarios_col_name">Scenario</div>
              <div id="opt_scenarios_col_result">Impact</div>
              <div id="opt_scenarios_col_note">Notes</div>
            </div>

            <div class="truck-row">
              <div>Merge low-load return trip with new shipment</div>
              <div><span class="chip good">+18% load factor</span></div>
              <div>Assign new load to empty-backhaul truck instead of creating a new trip.</div>
            </div>

            <div class="truck-row">
              <div>Shift flexible shipment to night route</div>
              <div><span class="chip warn">-9% cost</span></div>
              <div>Use cheaper night tariff while keeping SLA within 24 hours.</div>
            </div>

            <div class="truck-row">
              <div>Consolidate two partial city deliveries</div>
              <div><span class="chip good">-15% COâ‚‚</span></div>
              <div>Combine nearby drops in one route instead of two half-empty trucks.</div>
            </div>

            <div class="truck-row">
              <div>Block unprofitable urgent request</div>
              <div><span class="chip bad">Avoid loss</span></div>
              <div>AI flags trips where revenue &lt; variable cost to prevent accepting bad orders.</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div class="support-footer">
      <div class="support-box">
        <div class="support-title" id="support_title">Customer Support</div>
        <div class="support-row">
          <span class="support-icon">ğŸ“</span>
          <span id="support_phone_label">Phone:</span>&nbsp;<span>+966 55 555 5555</span>
        </div>
        <div class="support-row">
          <span class="support-icon">ğŸ“§</span>
          <span id="support_email_label">Email:</span>&nbsp;<span>support@logixperts.com</span>
        </div>
        <div class="support-row">
          <span class="support-icon">ğŸ“ </span>
          <span id="support_fax_label">Fax:</span>&nbsp;<span>011-1234567</span>
        </div>
      </div>
    </div>

    <footer>
      Logixperts Â· Smart Load Analyzer Â· Naqlthon 4
    </footer>
  </div>

  <!-- ===== ÙƒÙ„ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ø¯Ø§Ø®Ù„ module ÙˆØ§Ø­Ø¯ Ù…Ø¹ Firebase ===== -->
  <script type="module">
    // Firebase modular imports Ù…Ù† CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      addDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
    const firebaseConfig = {
      apiKey: "AIzaSyAjbvQo7NrGZiFbFbdY3a7UtDjlv0SwU3w",
      authDomain: "smart-load-analyzer-56cb2.firebaseapp.com",
      projectId: "smart-load-analyzer-56cb2",
      storageBucket: "smart-load-analyzer-56cb2.firebasestorage.app",
      messagingSenderId: "253721588070",
      appId: "1:253721588070:web:c24bc2fbc27c2fba9e18a7",
      measurementId: "G-60RF97SGWN"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== Ø§Ù„Ù„ØºØ© =====
    let currentLang = "en";

    const translations = {
      en: {
        brand: "Logixperts",
        subbrand: "Smart Load Analyzer",
        team_label: "Team:",
        team_event: "Naqlthon 4",

        company_code_label: "Company code:",

        hero_title: "Reduce Empty Trips. Boost Load Factor. Go Greener.",
        hero_sub: "Smart Load Analyzer helps freight companies analyze and optimize loads to reduce cost and emissions.",
        hero_highlight: "This demo scenario shows how merging a new shipment with a low-load return trip improves load factor.",
        tag_fuel: "fuel reduction (simulated)",
        tag_ai: "load & route suggestions",

        hero_avg_before_title: "Avg load (baseline)",
        hero_cost_title: "Op. cost / day",
        hero_co2_title: "COâ‚‚ / day",

        tab_login: "Login / Sign up",
        tab_dashboard: "Dashboard",
        tab_analyze: "Analyze Load",
        tab_opt: "Optimization Result",

        login_title: "Company Login",
        login_sub: "Access your Smart Load Analyzer workspace.",
        login_btn: "Login",
        login_hint: "Demo: demo@logixperts.sa / Naqlthon4!",
        label_email: "Company email",
        label_password: "Password",

        signup_title: "Create Company Account",
        signup_sub: "Create your company account to access the system.",
        signup_label_name: "Company name",
        signup_label_email: "Company email",
        signup_label_pass: "Password",
        signup_label_fleet: "Fleet size (trucks)",
        signup_label_plan: "Subscription plan",
        signup_btn: "Sign up",

        dash_title: "Fleet Overview Dashboard",
        dash_sub: "4 demo trucks on main corridors.",

        kpi_trucks_label: "Trucks in scenario",
        kpi_baseline_label: "Avg load (baseline)",
        kpi_baseline_note: "Before optimization",
        kpi_after_label: "Avg load (after)",
        kpi_after_note: "After last run",
        kpi_cost_before_label: "Op. cost / day",
        kpi_cost_before_note: "Simulated SAR",
        kpi_cost_after_label: "Op. cost / day (after)",
        kpi_co2_before_label: "COâ‚‚ / day",
        kpi_co2_before_note: "kg COâ‚‚",
        kpi_co2_after_label: "COâ‚‚ / day (after)",

        stats_label_load: "Company avg load (%)",
        stats_label_cost: "Company op. cost / day (SAR)",
        stats_label_co2: "Company COâ‚‚ / day (kg)",
        stats_save_btn: "Save metrics",
        stats_hint_default: "These values are stored per company and reused on each login.",

        map_title: "Truck Positions & Routes",
        map_sub: "Best routes + load factor markers.",

        analyze_title: "Analyze New Shipment (Manual)",
        analyze_sub: "Enter shipment details manually.",
        label_weight: "Weight (tons)",
        label_volume: "Volume (mÂ³)",
        label_destination: "Destination city",
        label_delivery: "Delivery window",
        label_priority: "Priority",
        btn_manual_analyze: "Run Manual Optimization",

        // AI Tools
        ai_title: "AI Tools",
        ai_sub: "Use AI to analyze trips and generate reports (demo).",
        ai_trip_label: "Trip description / notes",
        ai_trip_placeholder: "Paste trip summary or issues here...",
        ai_trip_btn: "Generate AI insights (demo)",
        ai_pdf_label: "PDF AI Report (coming soon)",
        ai_pdf_hint: "In the real system this will send your PDF to an AI backend and return KPIs + summary.",

        csv_title: "Upload Your Trips CSV",
        csv_sub: "Upload trip history to improve optimization accuracy.",
        csv_label: "Choose CSV file",
        btn_csv: "Analyze CSV",

        opt_title: "Optimization Result",
        opt_sub: "Recommended load distribution.",
        opt_col_truck: "Truck & Route",
        opt_col_load: "Load Factor",
        opt_col_ai: "AI Suggestion",

        chart_title: "Before vs After Optimization",
        chart_sub: "Average load improvement",

        // Optimization scenarios card
        opt_scenarios_title: "Optimization Scenarios",
        opt_scenarios_sub: "Examples of how Smart Load Analyzer improves utilization.",
        opt_scenarios_col_name: "Scenario",
        opt_scenarios_col_result: "Impact",
        opt_scenarios_col_note: "Notes",

        support_title: "Customer Support",
        support_phone_label: "Phone:",
        support_email_label: "Email:",
        support_fax_label: "Fax:",
        back_link: "â† Back to role selection"
      },
      ar: {
        brand: "Ù„ÙˆÚ†ÙƒØ³Ø¨Ø±ØªØ³",
        subbrand: "Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ",
        team_label: "Ø§Ù„ÙØ±ÙŠÙ‚:",
        team_event: "Ù†Ù‚Ù„-Ø«ÙˆÙ† 4",

        company_code_label: "ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©:",

        hero_title: "Ù‚Ù„Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙˆØ§Ø±ÙØ¹ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©.",
        hero_sub: "ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ ÙˆØªØ­Ø³ÙŠÙ† Ø­Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª.",
        hero_highlight: "ÙŠÙˆØ¶Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙƒÙŠÙ ÙŠØ±ÙØ¹ Ø¯Ù…Ø¬ Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø­Ù…ÙˆÙ„Ø© Ø±Ø­Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ø­Ù…Ù„.",
        tag_fuel: "ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ù…Ø­Ø§ÙƒØ§Ø©)",
        tag_ai: "Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø°ÙƒÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ø­Ù…ÙˆÙ„Ø©",

        hero_avg_before_title: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Ù‚Ø¨Ù„)",
        hero_cost_title: "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙŠÙˆÙ…",
        hero_co2_title: "Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ / Ø§Ù„ÙŠÙˆÙ…",

        tab_login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
        tab_dashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
        tab_analyze: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©",
        tab_opt: "Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†",

        login_title: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø±ÙƒØ©",
        login_sub: "Ø§Ø¯Ø®Ù„ Ø¥Ù„Ù‰ Ù…Ù†ØµØªÙƒ.",
        login_btn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        login_hint: "Ø­Ø³Ø§Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ: demo@logixperts.sa / Naqlthon4!",
        label_email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø´Ø±ÙƒØ©",
        label_password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",

        signup_title: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø´Ø±ÙƒØ©",
        signup_sub: "Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø±ÙƒØªÙƒ.",
        signup_label_name: "Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©",
        signup_label_email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
        signup_label_pass: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        signup_label_fleet: "Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª",
        signup_label_plan: "Ø§Ù„Ø®Ø·Ø©",
        signup_btn: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",

        dash_title: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø³Ø·ÙˆÙ„",
        dash_sub: "Ù¤ Ø´Ø§Ø­Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.",

        kpi_trucks_label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬",
        kpi_baseline_label: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Ù‚Ø¨Ù„)",
        kpi_baseline_note: "Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø³ÙŠÙ†",
        kpi_after_label: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Ø¨Ø¹Ø¯)",
        kpi_after_note: "Ø¨Ø¹Ø¯ Ø¢Ø®Ø± ØªØ´ØºÙŠÙ„",
        kpi_cost_before_label: "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙŠÙˆÙ…",
        kpi_cost_before_note: "Ø±ÙŠØ§Ù„ (Ù…Ø­Ø§ÙƒØ§Ø©)",
        kpi_cost_after_label: "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø¹Ø¯)",
        kpi_co2_before_label: "Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ / Ø§Ù„ÙŠÙˆÙ…",
        kpi_co2_before_note: "ÙƒØ¬Ù… COâ‚‚",
        kpi_co2_after_label: "Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ / Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø¹Ø¯)",

        stats_label_load: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ù„Ù„Ø´Ø±ÙƒØ© (%)",
        stats_label_cost: "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙŠÙˆÙ… (Ø±ÙŠØ§Ù„)",
        stats_label_co2: "Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ / Ø§Ù„ÙŠÙˆÙ… (ÙƒØ¬Ù…)",
        stats_save_btn: "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
        stats_hint_default: "ÙŠØªÙ… Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ù„ÙƒÙ„ Ø´Ø±ÙƒØ© ÙˆØªØ³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ÙƒÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.",

        map_title: "Ù…ÙˆØ§Ù‚Ø¹ ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª",
        map_sub: "Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª + Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­Ù…ÙˆÙ„Ø©.",

        analyze_title: "ØªØ­Ù„ÙŠÙ„ Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙŠØ¯ÙˆÙŠ)",
        analyze_sub: "Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§.",
        label_weight: "Ø§Ù„ÙˆØ²Ù† (Ø·Ù†)",
        label_volume: "Ø§Ù„Ø­Ø¬Ù… (Ù…Â³)",
        label_destination: "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØ¬Ù‡Ø©",
        label_delivery: "Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…",
        label_priority: "Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©",
        btn_manual_analyze: "ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠ",

        // AI Tools
        ai_title: "Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
        ai_sub: "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± (Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ).",
        ai_trip_label: "ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©",
        ai_trip_placeholder: "Ø§Ù„ØµÙ‚ ÙˆØµÙ Ø§Ù„Ø±Ø­Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§...",
        ai_trip_btn: "ØªÙˆÙ„ÙŠØ¯ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)",
        ai_pdf_label: "ØªÙ‚Ø±ÙŠØ± PDF Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ù‚Ø±ÙŠØ¨Ù‹Ø§)",
        ai_pdf_hint: "ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù PDF Ù„Ù…Ø­Ø±Ùƒ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ù…Ù„Ø®Øµ + Ù…Ø¤Ø´Ø±Ø§Øª Ø£Ø¯Ø§Ø¡.",

        csv_title: "Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø±Ø­Ù„Ø§Øª (CSV)",
        csv_sub: "Ø§Ø±ÙØ¹ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†.",
        csv_label: "Ø§Ø®ØªØ± Ù…Ù„Ù CSV",
        btn_csv: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù",

        opt_title: "Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†",
        opt_sub: "Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù„Ù„Ø£Ø­Ù…Ø§Ù„.",
        opt_col_truck: "Ø§Ù„Ø´Ø§Ø­Ù†Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø±",
        opt_col_load: "Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©",
        opt_col_ai: "Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ù†Ø¸Ø§Ù…",

        chart_title: "Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†",
        chart_sub: "ØªØ­Ø³Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø©",

        opt_scenarios_title: "Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†",
        opt_scenarios_sub: "Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ ÙƒÙŠÙ ÙŠØ­Ø³Ù‘Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ø³ØªØºÙ„Ø§Ù„ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª.",
        opt_scenarios_col_name: "Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ",
        opt_scenarios_col_result: "Ø§Ù„Ø£Ø«Ø±",
        opt_scenarios_col_note: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",

        support_title: "Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
        support_phone_label: "Ø§Ù„Ù‡Ø§ØªÙ:",
        support_email_label: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:",
        support_fax_label: "ÙØ§ÙƒØ³:",
        back_link: "â† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
      }
    };

    function applyLanguage() {
      const t = translations[currentLang];

      document.getElementById("text_brand").innerText = t.brand;
      document.getElementById("text_subbrand").innerText = t.subbrand;
      document.getElementById("team_label").innerText = t.team_label;
      document.getElementById("team_event").innerText = t.team_event;

      const codeLabel = document.getElementById("company_code_label");
      if (codeLabel) codeLabel.innerText = t.company_code_label;

      document.getElementById("hero_title").innerText = t.hero_title;
      document.getElementById("hero_sub").innerText = t.hero_sub;
      document.getElementById("hero_highlight").innerText = t.hero_highlight;
      document.getElementById("tag_fuel").innerText = t.tag_fuel;
      document.getElementById("tag_ai").innerText = t.tag_ai;

      document.getElementById("hero_avg_before_title").innerText = t.hero_avg_before_title;
      document.getElementById("hero_cost_title").innerText = t.hero_cost_title;
      document.getElementById("hero_co2_title").innerText = t.hero_co2_title;

      document.getElementById("tab_login").innerText = t.tab_login;
      document.getElementById("tab_dashboard").innerText = t.tab_dashboard;
      document.getElementById("tab_analyze").innerText = t.tab_analyze;
      document.getElementById("tab_opt").innerText = t.tab_opt;

      document.getElementById("login_title").innerText = t.login_title;
      document.getElementById("login_sub").innerText = t.login_sub;
      document.getElementById("login_btn").innerText = t.login_btn;
      document.getElementById("login_hint").innerText = t.login_hint;
      document.getElementById("label_email").innerText = t.label_email;
      document.getElementById("label_password").innerText = t.label_password;

      document.getElementById("signup_title").innerText = t.signup_title;
      document.getElementById("signup_sub").innerText = t.signup_sub;
      document.getElementById("signup_label_name").innerText = t.signup_label_name;
      document.getElementById("signup_label_email").innerText = t.signup_label_email;
      document.getElementById("signup_label_pass").innerText = t.signup_label_pass;
      document.getElementById("signup_label_fleet").innerText = t.signup_label_fleet;
      document.getElementById("signup_label_plan").innerText = t.signup_label_plan;
      document.getElementById("signup_btn").innerText = t.signup_btn;

      document.getElementById("dash_title").innerText = t.dash_title;
      document.getElementById("dash_sub").innerText = t.dash_sub;
      document.getElementById("kpi_trucks_label").innerText = t.kpi_trucks_label;
      document.getElementById("kpi_baseline_label").innerText = t.kpi_baseline_label;
      document.getElementById("kpi_baseline_note").innerText = t.kpi_baseline_note;
      document.getElementById("kpi_after_label").innerText = t.kpi_after_label;
      document.getElementById("kpi_after_note").innerText = t.kpi_after_note;
      document.getElementById("kpi_cost_before_label").innerText = t.kpi_cost_before_label;
      document.getElementById("kpi_cost_before_note").innerText = t.kpi_cost_before_note;
      document.getElementById("kpi_cost_after_label").innerText = t.kpi_cost_after_label;
      document.getElementById("kpi_co2_before_label").innerText = t.kpi_co2_before_label;
      document.getElementById("kpi_co2_before_note").innerText = t.kpi_co2_before_note;
      document.getElementById("kpi_co2_after_label").innerText = t.kpi_co2_after_label;

      document.getElementById("stats_label_load").innerText = t.stats_label_load;
      document.getElementById("stats_label_cost").innerText = t.stats_label_cost;
      document.getElementById("stats_label_co2").innerText = t.stats_label_co2;
      document.getElementById("stats-save-btn").innerText = t.stats_save_btn;
      document.getElementById("stats_hint").innerText = t.stats_hint_default;

      document.getElementById("map_title").innerText = t.map_title;
      document.getElementById("map_sub").innerText = t.map_sub;

      document.getElementById("analyze_title").innerText = t.analyze_title;
      document.getElementById("analyze_sub").innerText = t.analyze_sub;
      document.getElementById("label_weight").innerText = t.label_weight;
      document.getElementById("label_volume").innerText = t.label_volume;
      document.getElementById("label_destination").innerText = t.label_destination;
      document.getElementById("label_delivery").innerText = t.label_delivery;
      document.getElementById("label_priority").innerText = t.label_priority;
      document.getElementById("btn_manual_analyze").innerText = t.btn_manual_analyze;

      // AI tools texts
      document.getElementById("ai_title").innerText = t.ai_title;
      document.getElementById("ai_sub").innerText = t.ai_sub;
      document.getElementById("ai_trip_label").innerText = t.ai_trip_label;
      const aiTripText = document.getElementById("ai_trip_text");
      if (aiTripText) aiTripText.placeholder = t.ai_trip_placeholder;
      document.getElementById("ai_trip_btn").innerText = t.ai_trip_btn;
      document.getElementById("ai_pdf_label").innerText = t.ai_pdf_label;
      document.getElementById("ai_pdf_hint").innerText = t.ai_pdf_hint;

      document.getElementById("csv_title").innerText = t.csv_title;
      document.getElementById("csv_sub").innerText = t.csv_sub;
      document.getElementById("csv_label").innerText = t.csv_label;
      document.getElementById("btn_csv").innerText = t.btn_csv;

      document.getElementById("opt_title").innerText = t.opt_title;
      document.getElementById("opt_sub").innerText = t.opt_sub;
      document.getElementById("opt_col_truck").innerText = t.opt_col_truck;
      document.getElementById("opt_col_load").innerText = t.opt_col_load;
      document.getElementById("opt_col_ai").innerText = t.opt_col_ai;

      document.getElementById("chart_title").innerText = t.chart_title;
      document.getElementById("chart_sub").innerText = t.chart_sub;

      document.getElementById("opt_scenarios_title").innerText = t.opt_scenarios_title;
      document.getElementById("opt_scenarios_sub").innerText = t.opt_scenarios_sub;
      document.getElementById("opt_scenarios_col_name").innerText = t.opt_scenarios_col_name;
      document.getElementById("opt_scenarios_col_result").innerText = t.opt_scenarios_col_result;
      document.getElementById("opt_scenarios_col_note").innerText = t.opt_scenarios_col_note;

      document.getElementById("support_title").innerText = t.support_title;
      document.getElementById("support_phone_label").innerText = t.support_phone_label;
      document.getElementById("support_email_label").innerText = t.support_email_label;
      document.getElementById("support_fax_label").innerText = t.support_fax_label;
      document.getElementById("back_link").innerText = t.back_link;

      if (currentLang === "ar") {
        document.documentElement.lang = "ar";
        document.documentElement.dir = "rtl";
        document.getElementById("langSwitcher").innerText = "EN";
        document.querySelector(".support-title").style.textAlign = "right";
      } else {
        document.documentElement.lang = "en";
        document.documentElement.dir = "ltr";
        document.getElementById("langSwitcher").innerText = "AR";
        document.querySelector(".support-title").style.textAlign = "left";
      }
    }

    function toggleLanguage() {
      currentLang = currentLang === "en" ? "ar" : "en";
      applyLanguage();
    }

    // ===== SCENARIO =====
    const CAPACITY_TONS = 20;
    const BASE_TRIP_COST = 1000;
    const EMISSION_FACTOR = 2.7;

    const trucksScenario = [
      { id: "Truck #1", origin: "Riyadh", dest: "Jeddah", currentLoad: 0.75, coords: [24.7136, 46.6753] },
      { id: "Truck #2", origin: "Jeddah", dest: "Riyadh", currentLoad: 0.40, coords: [21.4858, 39.1925] },
      { id: "Truck #3", origin: "Riyadh", dest: "Dammam", currentLoad: 0.65, coords: [24.7136, 46.6753] },
      { id: "Truck #4", origin: "Dammam", dest: "Riyadh", currentLoad: 0.50, coords: [26.4207, 50.0888] },
    ];

    const cityCoords = {
      riyadh:  [24.7136, 46.6753],
      jeddah:  [21.4858, 39.1925],
      dammam:  [26.4207, 50.0888],
    };

    // default baseline Ù…Ù† Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ (Ù„Ùˆ Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ø§ Ø³Ø¬Ù„Øª Ø´ÙŠØ¡)
    let baselineAvgLoad =
      trucksScenario.reduce((sum, t) => sum + t.currentLoad, 0) / trucksScenario.length;
    let baselineCost = trucksScenario.length * BASE_TRIP_COST;
    let baselineCO2 = baselineCost * EMISSION_FACTOR;

    let dashboardChart, optChart, mapInstance;
    let isLoggedIn = false;
    let currentCompanyId = null;
    let currentCompanyData = null;
    let companyStats = null;

    const tabs = document.querySelectorAll(".nav-tab");
    const views = document.querySelectorAll(".view");

    function setActiveView(id) {
      // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©: Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨ØºÙŠØ± login-view Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
      if (!isLoggedIn && id !== "login-view") {
        id = "login-view";
      }

      tabs.forEach(t => {
        t.classList.toggle("active", t.getAttribute("data-view") === id);
      });
      views.forEach(v => {
        v.classList.toggle("active", v.id === id);
      });
    }

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const viewId = tab.getAttribute("data-view");
        if (!isLoggedIn && viewId !== "login-view") {
          setActiveView("login-view");
          return;
        }
        setActiveView(viewId);
        if (viewId === "dashboard-view") {
          initMap();
          if (mapInstance) setTimeout(() => mapInstance.invalidateSize(), 0);
        }
      });
    });

    function togglePassword(inputId, btn) {
      const input = document.getElementById(inputId);
      if (!input) return;
      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "Hide";
      } else {
        input.type = "password";
        btn.textContent = "Show";
      }
    }

    // ===== signUp Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø¹ companyCode =====
    async function signUp() {
      const name = document.getElementById("signup-name").value.trim();
      const email = document.getElementById("signup-email").value.trim().toLowerCase();
      const password = document.getElementById("signup-password").value;
      const fleet = parseInt(document.getElementById("signup-fleet").value || "0", 10);
      const plan = document.getElementById("signup-plan").value;
      const msg = document.getElementById("signup-message");

      if (!name || !email || !password) {
        msg.textContent = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."
          : "Please fill in name, email and password.";
        return;
      }

      try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Auth
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCred.user.uid;

        // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ© ØªÙ„Ù‚Ø§Ø¦ÙŠ
        let base = name.replace(/[^A-Za-z0-9]/g, "").toUpperCase().slice(0, 4);
        if (!base) base = "COMP";
        const random = Math.floor(100 + Math.random() * 900); // 100-999
        const companyCode = base + random; // Ù…Ø«Ø§Ù„: LOGI123

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Firestore
        await setDoc(doc(db, "companies", uid), {
          companyName: name,
          email,
          companyCode,
          fleetSize: isNaN(fleet) ? 0 : fleet,
          plan,
          createdAt: serverTimestamp()
        });

        const msgEn =
          `Company account created. Your company code: ${companyCode}. You can now log in.`;
        const msgAr =
          `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙƒØ©. ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: ${companyCode}. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.`;
        msg.textContent = currentLang === "ar" ? msgAr : msgEn;

        // ØªØ¹Ø¨Ø¦Ø© ÙÙˆØ±Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        document.getElementById("company").value = email;
        document.getElementById("password").value = password;

      } catch (err) {
        console.error(err);
        msg.textContent = currentLang === "ar"
          ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨."
          : "Error while creating the account.";
      }
    }

    // ===== Login Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© =====
    async function demoLogin() {
      const email = document.getElementById("company").value.trim().toLowerCase();
      const password = document.getElementById("password").value;
      const errorEl = document.getElementById("login-error");

      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const uid = userCred.user.uid;

        const companyRef = doc(db, "companies", uid);
        const companySnap = await getDoc(companyRef);

        if (!companySnap.exists()) {
          errorEl.textContent = currentLang === "ar"
            ? "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©."
            : "Company data not found.";
          return;
        }

        const companyData = companySnap.data();
        handleLoginSuccess(uid, companyData);
        errorEl.textContent = "";

        // Ø¹Ø±Ø¶ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ ØªÙ„Ù…ÙŠØ­ Ø¨Ø³ÙŠØ·
        if (companyData.companyCode) {
          const hint = currentLang === "ar"
            ? `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©: ${companyData.companyCode}.`
            : `Logged in. Company code: ${companyData.companyCode}.`;
          document.getElementById("login_hint").textContent = hint;
        }
      } catch (err) {
        console.error(err);
        errorEl.textContent = currentLang === "ar"
          ? "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©."
          : "Invalid credentials. Please check your email and password.";
      }
    }

    function initCompanyStats(statsFromDb) {
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const defaultStats = {
        avgLoad: baselineAvgLoad * 100,
        dailyCost: baselineCost,
        dailyCO2: baselineCO2
      };

      const stats = {
        avgLoad: (statsFromDb && typeof statsFromDb.avgLoad === "number")
          ? statsFromDb.avgLoad
          : defaultStats.avgLoad,
        dailyCost: (statsFromDb && typeof statsFromDb.dailyCost === "number")
          ? statsFromDb.dailyCost
          : defaultStats.dailyCost,
        dailyCO2: (statsFromDb && typeof statsFromDb.dailyCO2 === "number")
          ? statsFromDb.dailyCO2
          : defaultStats.dailyCO2
      };

      companyStats = stats;

      // ØªØ­Ø¯ÙŠØ« baseline Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
      if (stats.avgLoad && stats.avgLoad > 0) {
        baselineAvgLoad = stats.avgLoad / 100;
      }
      if (stats.dailyCost && stats.dailyCost > 0) {
        baselineCost = stats.dailyCost;
      }
      if (stats.dailyCO2 && stats.dailyCO2 > 0) {
        baselineCO2 = stats.dailyCO2;
      }

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
      const loadPct = (baselineAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("kpi-load-before").textContent = loadPct;
      document.getElementById("hero-load-before").textContent = loadPct;
      document.getElementById("kpi-cost-before").textContent = "~" + baselineCost.toFixed(0) + " SAR";
      document.getElementById("hero-cost-before").textContent = "~" + baselineCost.toFixed(0) + " SAR";
      document.getElementById("kpi-co2-before").textContent = "~" + baselineCO2.toFixed(0) + " kg";
      document.getElementById("hero-co2-before").textContent = "~" + baselineCO2.toFixed(0) + " kg";

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙˆØ±Ù…
      const loadInput = document.getElementById("stats-load");
      const costInput = document.getElementById("stats-cost");
      const co2Input = document.getElementById("stats-co2");
      if (loadInput) loadInput.value = stats.avgLoad.toFixed(0);
      if (costInput) costInput.value = stats.dailyCost.toFixed(0);
      if (co2Input) co2Input.value = stats.dailyCO2.toFixed(0);
    }

    async function saveCompanyStats() {
      if (!isLoggedIn || !currentCompanyId) return;

      const loadVal = parseFloat(document.getElementById("stats-load").value || "0");
      const costVal = parseFloat(document.getElementById("stats-cost").value || "0");
      const co2Val  = parseFloat(document.getElementById("stats-co2").value || "0");
      const hintEl  = document.getElementById("stats_hint");

      if (isNaN(loadVal) || isNaN(costVal) || isNaN(co2Val) || loadVal <= 0) {
        hintEl.textContent = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø©ØŒ Ø®Ø§ØµØ© Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø©."
          : "Please enter valid values, especially average load.";
        return;
      }

      const newStats = {
        avgLoad: loadVal,
        dailyCost: costVal,
        dailyCO2: co2Val
      };

      try {
        await setDoc(
          doc(db, "companies", currentCompanyId),
          { stats: newStats },
          { merge: true }
        );
        initCompanyStats(newStats);
        hintEl.textContent = currentLang === "ar"
          ? "ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­."
          : "Company metrics saved.";
      } catch (err) {
        console.error(err);
        hintEl.textContent = currentLang === "ar"
          ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."
          : "Error while saving metrics.";
      }
    }

    function handleLoginSuccess(uid, companyData) {
      isLoggedIn = true;
      currentCompanyId = uid;
      currentCompanyData = companyData || null;

      // ØªÙ‡ÙŠØ¦Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø±ÙƒØ© (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)
      initCompanyStats(companyData && companyData.stats ? companyData.stats : null);

      // Ø¹Ø±Ø¶ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
      if (companyData && companyData.companyCode) {
        const badge = document.getElementById("company_code_badge");
        const valueEl = document.getElementById("company_code_value");
        if (badge && valueEl) {
          valueEl.textContent = companyData.companyCode;
          badge.style.display = "inline-flex";
        }
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ baseline Ø§Ù„Ø­Ø§Ù„ÙŠ
      initCharts(baselineAvgLoad, baselineAvgLoad);
      populateOptimizationTableInitial();

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
      document.getElementById("tab_login").style.display = "none";
      document.getElementById("tab_dashboard").style.display = "inline-flex";
      document.getElementById("tab_analyze").style.display = "inline-flex";
      document.getElementById("tab_opt").style.display = "inline-flex";

      setActiveView("dashboard-view");
      initMap();
      if (mapInstance) setTimeout(() => mapInstance.invalidateSize(), 0);
    }

    function initCharts(loadBefore, loadAfter) {
      const beforeVal = loadBefore * 100;
      const afterVal = loadAfter * 100;

      const dbCtx = document.getElementById("dashboardChart");
      if (dbCtx && window.Chart && !dashboardChart) {
        dashboardChart = new Chart(dbCtx, {
          type: "line",
          data: {
            labels: ["Trip 1", "Trip 2", "Trip 3", "Trip 4"],
            datasets: [{
              label: "Average load factor %",
              data: [54, 58, 60, beforeVal],
              tension: 0.3,
              fill: true
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { min: 0, max: 100, ticks: { stepSize: 20 } },
            },
            plugins: {
              legend: { labels: { color: "#9ca3af", font: { size: 11 } } },
            },
          },
        });
      }

      const optCtx = document.getElementById("optChart");
      if (optCtx && window.Chart && !optChart) {
        optChart = new Chart(optCtx, {
          type: "bar",
          data: {
            labels: ["Baseline avg", "After optimization"],
            datasets: [{
              label: "Average load factor %",
              data: [beforeVal, afterVal],
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { min: 0, max: 100, ticks: { stepSize: 20 } },
            },
            plugins: { legend: { display: false } },
          },
        });
      }
    }

    function updateOptChart(loadAfter) {
      if (!optChart) return;
      const beforeVal = baselineAvgLoad * 100;
      const afterVal = loadAfter * 100;
      optChart.data.datasets[0].data = [beforeVal, afterVal];
      optChart.update();
    }

    function initMap() {
      const mapEl = document.getElementById("map");
      if (!mapEl || !window.L) return;

      if (!mapInstance) {
        mapInstance = L.map("map").setView([24.7136, 46.6753], 5.5);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(mapInstance);

        trucksScenario.forEach(t => {
          const originKey = t.origin.toLowerCase();
          const destKey   = t.dest.toLowerCase();
          const originCoord = cityCoords[originKey];
          const destCoord   = cityCoords[destKey];

          if (originCoord && destCoord) {
            const color = originKey === "riyadh" ? "#22c55e" : "#3b82f6";
            L.polyline([originCoord, destCoord], {
              color,
              weight: 3,
              opacity: 0.8,
              dashArray: "6,6",
            }).addTo(mapInstance);
          }
        });

        trucksScenario.forEach(t => {
          const load = t.currentLoad;
          const color = load > 0.7 ? "green" : load > 0.55 ? "orange" : "red";

          const marker = L.circleMarker(t.coords, {
            radius: 9,
            color,
            fillColor: color,
            fillOpacity: 0.8,
          }).addTo(mapInstance);

          marker.bindPopup(
            `${t.id}<br>${t.origin} â†’ ${t.dest}<br>Load factor: ${(load * 100).toFixed(0)}%`
          );
        });
      }
    }

    function populateOptimizationTableInitial() {
      populateOptimizationTable(trucksScenario, null);
    }

    function populateOptimizationTable(trucks, suggestionById) {
      const listEl = document.getElementById("truck-list");
      const t = translations[currentLang];

      listEl.innerHTML =
        '<div class="truck-row header">' +
        `<div id="opt_col_truck">${t.opt_col_truck}</div>` +
        `<div id="opt_col_load">${t.opt_col_load}</div>` +
        `<div id="opt_col_ai">${t.opt_col_ai}</div>` +
        '</div>';

      trucks.forEach(tr => {
        const suggestion = suggestionById ? suggestionById[tr.id] : null;
        const load = suggestion ? suggestion.newLoad : tr.currentLoad;
        const lf = (load * 100).toFixed(0) + "%";
        const chipClass = load < 0.55 ? "bad" : (load < 0.7 ? "warn" : "good");
        const actionText = suggestion
          ? suggestion.action
          : (currentLang === "ar" ? "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©" : "Waiting for new shipment");

        const row = document.createElement("div");
        row.className = "truck-row";
        row.innerHTML =
          `<div>${tr.id} â€” ${tr.origin} â†’ ${tr.dest}</div>` +
          `<div><span class="chip ${chipClass}">${lf}</span></div>` +
          `<div>${actionText}</div>`;
        listEl.appendChild(row);
      });
    }

    async function saveOptimizationResult(companyId, data) {
      if (!db || !companyId) return;
      try {
        await addDoc(
          collection(db, "companies", companyId, "optimizations"),
          {
            ...data,
            createdAt: serverTimestamp()
          }
        );
      } catch (err) {
        console.error("Error saving optimization:", err);
      }
    }

    async function runOptimization() {
      if (!isLoggedIn) return;

      const weight = parseFloat(document.getElementById("weight").value || "0");
      const volume = parseFloat(document.getElementById("volume").value || "0");
      let destinationInput = (document.getElementById("destination").value || "").toLowerCase();
      const priority = document.getElementById("priority").value;

      const trucks = trucksScenario.map(t => Object.assign({}, t));

      let destKey = destinationInput.trim();
      if (!destKey) destKey = "riyadh";

      let inbound = trucks.filter(t => t.dest.toLowerCase().includes(destKey));
      if (inbound.length === 0) {
        inbound = trucks.filter(t => t.dest.toLowerCase() === "riyadh");
      }

      let target = inbound[0];
      inbound.forEach(t => {
        if (priority === "high") {
          const diffT = Math.abs(t.currentLoad - 0.6);
          const diffCurrent = Math.abs(target.currentLoad - 0.6);
          if (diffT < diffCurrent) target = t;
        } else {
          if (t.currentLoad < target.currentLoad) target = t;
        }
      });

      const existingTons = target.currentLoad * CAPACITY_TONS;
      const addedTons = isNaN(weight) ? 0 : weight;
      const newTotalTons = existingTons + addedTons;
      const newLoadFactor = Math.min(1, newTotalTons / CAPACITY_TONS);
      target.newLoad = newLoadFactor;

      trucks.forEach(t => {
        if (t.id !== target.id) t.newLoad = t.currentLoad;
      });

      const afterAvgLoad =
        trucks.reduce((sum, t) => sum + t.newLoad, 0) / trucks.length;

      const costAfter = baselineCost * (baselineAvgLoad / afterAvgLoad);
      const co2After = baselineCO2 * (costAfter / baselineCost);

      const loadAfterPct = (afterAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("kpi-load-after").textContent = loadAfterPct;

      document.getElementById("kpi-cost-after").textContent = "~" + costAfter.toFixed(0) + " SAR";
      const costSavePct = ((baselineCost - costAfter) / baselineCost) * 100;
      document.getElementById("kpi-cost-savings").textContent =
        costSavePct > 0
          ? `-${costSavePct.toFixed(1)}% vs baseline`
          : (currentLang === "ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙÙŠØ±" : "No savings");

      document.getElementById("kpi-co2-after").textContent = "~" + co2After.toFixed(0) + " kg";
      const co2SavePct = ((baselineCO2 - co2After) / baselineCO2) * 100;
      document.getElementById("kpi-co2-savings").textContent =
        co2SavePct > 0
          ? `-${co2SavePct.toFixed(1)}% vs baseline`
          : (currentLang === "ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙÙŠØ±" : "No savings");

      if (!dashboardChart || !optChart) initCharts(baselineAvgLoad, afterAvgLoad);
      updateOptChart(afterAvgLoad);

      const suggestionById = {};
      suggestionById[target.id] = {
        truck: target,
        newLoad: newLoadFactor,
        action: currentLang === "ar"
          ? "Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø­Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø±Ø­Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø©"
          : "Merge new shipment with return trip",
      };
      populateOptimizationTable(trucks, suggestionById);

      const summary = document.getElementById("opt-summary");
      if (currentLang === "ar") {
        summary.innerHTML =
          `ØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø´Ø­Ù†Ø© ÙˆØ²Ù† <strong>${weight || 0} Ø·Ù†</strong> ` +
          `ÙˆØ­Ø¬Ù… <strong>${volume || 0} Ù…Â³</strong> Ø¥Ù„Ù‰ ` +
          `<strong>${target.id} (${target.origin} â†’ ${target.dest})</strong>ØŒ ` +
          `Ù…Ù…Ø§ ÙŠØ±ÙØ¹ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ù…Ù† <strong>${(baselineAvgLoad * 100).toFixed(0)}%</strong> ` +
          `Ø¥Ù„Ù‰ <strong>${(afterAvgLoad * 100).toFixed(0)}%</strong>ØŒ ` +
          `Ù…Ø¹ ØªÙ‚Ù„ÙŠÙ„ ØªÙ‚Ø±ÙŠØ¨ÙŠ ÙÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø³Ø¨Ø© <strong>${Math.abs(costSavePct).toFixed(1)}%</strong> ` +
          `ÙˆØ§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ Ø¨Ù†Ø³Ø¨Ø© <strong>${Math.abs(co2SavePct).toFixed(1)}%</strong>.`;
      } else {
        summary.innerHTML =
          `The new shipment of <strong>${weight || 0} tons</strong> / ` +
          `<strong>${volume || 0} mÂ³</strong> is assigned to ` +
          `<strong>${target.id} (${target.origin} â†’ ${target.dest})</strong>, ` +
          `raising average fleet load from <strong>${(baselineAvgLoad * 100).toFixed(0)}%</strong> ` +
          `to <strong>${(afterAvgLoad * 100).toFixed(0)}%</strong>, ` +
          `with an estimated reduction of <strong>${Math.abs(costSavePct).toFixed(1)}%</strong> ` +
          `in operating cost and <strong>${Math.abs(co2SavePct).toFixed(1)}%</strong> in COâ‚‚ emissions.`;
      }

      if (currentCompanyId) {
        await saveOptimizationResult(currentCompanyId, {
          shipmentWeight: weight || 0,
          shipmentVolume: volume || 0,
          destination: destinationInput || "",
          priority,
          assignedTruckId: target.id,
          assignedRoute: `${target.origin} â†’ ${target.dest}`,
          baselineAvgLoad,
          afterAvgLoad,
          baselineCost,
          costAfter,
          baselineCO2,
          co2After
        });
      }

      setActiveView("optimization-view");
    }

    function analyzeCSV() {
      if (!isLoggedIn) return;
      const fileInput = document.getElementById("csv_file");
      const msg = document.getElementById("csv_message");

      if (!fileInput.files || fileInput.files.length === 0) {
        msg.textContent = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù CSV Ø£ÙˆÙ„Ø§Ù‹."
          : "Please choose a CSV file first.";
        return;
      }

      msg.textContent = currentLang === "ar"
        ? "ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù (Ù…Ø­Ø§ÙƒØ§Ø©). Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª."
        : "CSV uploaded (demo). Trip history will be used to improve optimization suggestions.";

      populateOptimizationTableInitial();
      document.getElementById("opt-summary").textContent =
        currentLang === "ar"
          ? "ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù CSV (Ù…Ø­Ø§ÙƒØ§Ø©). ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª."
          : "CSV file processed (demo). Optimization based on trip history is shown here.";

      setActiveView("optimization-view");
    }

    // AI Tools demo logic
    function runAIToolsAnalysis() {
      if (!isLoggedIn) return;
      const text = (document.getElementById("ai_trip_text").value || "").trim();
      const out = document.getElementById("ai_trip_output");

      if (!text) {
        out.textContent = currentLang === "ar"
          ? "Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø±Ø­Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹."
          : "Please write a short description of the trip or issue first.";
        return;
      }

      // ØªØ­Ù„ÙŠÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø«Ø§Ø¨Øª â€“ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯ ÙØ¹Ù„ÙŠ
      out.textContent = currentLang === "ar"
        ? "ØªØ­Ù„ÙŠÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ: Ø§Ù„Ø±Ø­Ù„Ø© ØªØ¨Ø¯Ùˆ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¯Ù…Ø¬ Ù…Ø¹ Ø±Ø­Ù„Ø© Ø¹ÙˆØ¯Ø© Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ø£Ùˆ Ø±Ø­Ù„Ø© Ù„ÙŠÙ„ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª. ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø³ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª Ù‚Ø¨Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªÙˆØµÙŠØ©."
        : "Demo insight: this trip looks suitable for merging with a low-load return or shifting to a night route to cut cost and emissions. In the real system, the AI would read historical trips and routes before suggesting this.";
    }

    window.addEventListener("load", () => {
      document.getElementById("tab_login").style.display = "inline-flex";
      document.getElementById("tab_dashboard").style.display = "none";
      document.getElementById("tab_analyze").style.display = "none";
      document.getElementById("tab_opt").style.display = "none";

      const statsSaveBtn = document.getElementById("stats-save-btn");
      if (statsSaveBtn) {
        statsSaveBtn.addEventListener("click", saveCompanyStats);
      }

      applyLanguage();
      populateOptimizationTableInitial();
    });

    // Ø±Ø¨Ø· Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ù€ window Ù„ÙŠØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù€ HTML
    window.toggleLanguage  = toggleLanguage;
    window.togglePassword  = togglePassword;
    window.demoLogin       = demoLogin;
    window.signUp          = signUp;
    window.runOptimization = runOptimization;
    window.analyzeCSV      = analyzeCSV;
    window.runAIToolsAnalysis = runAIToolsAnalysis;
  </script>
</body>
</html>
